<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSW-OS [v28.03-FIXED]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @font-face {
            font-family: "PPSupplyMono";
            src: url("https://assets.codepen.io/7558/PPSupplyMono-Regular.ttf") format("truetype");
            font-weight: normal; font-style: normal; font-display: swap;
        }

        :root {
            --color-bg: #000000;
            --color-primary: #ff3c3c; /* Red */
            --color-secondary: #ff8c3c; /* Orange-Red */
            --color-tertiary: #9C27B0; /* Purple */
            --color-warning: #f5a623; /* Orange */
            --color-ok: #4caf50; /* Green */
            --color-info: #45f3ff; /* Cyan */
            --color-ally: #4A90E2; /* Blue */
            --color-text: #cccccc;
            --color-border: rgba(255, 60, 60, 0.15);
            --font-primary: "PPSupplyMono", "Courier New", monospace;
            --color-shift-primary: var(--color-primary);
            --color-shift-secondary: var(--color-secondary);
            --color-shift-tertiary: var(--color-tertiary);
        }
        
        body.theme-crimson { --color-primary: #DC143C; --color-secondary: #FF4500; --color-tertiary: #9C27B0; --color-border: rgba(220, 20, 60, 0.15); }
        body.theme-helios { --color-primary: #9cd4c4; --color-secondary: #6aa394; --color-tertiary: #87CEEB; --color-border: rgba(156, 212, 196, 0.15); }
        body.theme-cobalt { --color-primary: #1976D2; --color-secondary: #29B6F6; --color-tertiary: #45f3ff; --color-border: rgba(25, 118, 210, 0.15); }
        body.theme-hunter { --color-primary: #2E7D32; --color-secondary: #66BB6A; --color-tertiary: #4CAF50; --color-border: rgba(46, 125, 50, 0.15); }
        body.theme-amber { --color-primary: #FFA000; --color-secondary: #FFCA28; --color-tertiary: #f5a623; --color-border: rgba(255, 160, 0, 0.15); }
        body.theme-orion { --color-primary: #4A90E2; --color-secondary: #50E3C2; --color-tertiary: #45f3ff; --color-border: rgba(74, 144, 226, 0.15); }
        body.theme-void { --color-primary: #9C27B0; --color-secondary: #00BCD4; --color-tertiary: #ba68c8; --color-border: rgba(156, 39, 176, 0.15); }
        body.theme-plasma { --color-primary: #00FF00; --color-secondary: #7FFF00; --color-tertiary: #00FFFF; --color-border: rgba(0, 255, 0, 0.15); }
        body.theme-sunset { --color-primary: #FF4500; --color-secondary: #FF69B4; --color-tertiary: #8A2BE2; --color-border: rgba(255, 69, 0, 0.15); }
        body.theme-glacial { --color-primary: #FFFFFF; --color-secondary: #ADD8E6; --color-tertiary: #E0FFFF; --color-border: rgba(255, 255, 255, 0.15); }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-primary);
            overflow: hidden;
            cursor: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-secondary); }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        #noise-overlay {
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: transparent url("https://assets.codepen.io/7558/noise.png") repeat 0 0;
            background-size: 300px 300px;
            animation: noise-animation 0.2s steps(4) infinite;
            opacity: 0.8;
            will-change: transform;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes noise-animation {
            0% { transform: translate(0, 0); } 10% { transform: translate(-1%, -1%); } 20% { transform: translate(1%, -2%); } 30% { transform: translate(-1%, 2%); } 40% { transform: translate(1%, -1%); } 50% { transform: translate(-1%, 2%); } 60% { transform: translate(-2%, 1%); } 70% { transform: translate(2%, 1%); } 80% { transform: translate(1%, -1%); } 90% { transform: translate(-1%, 2%); } 100% { transform: translate(1%, 0); }
        }

        #custom-cursor {
            position: fixed;
            width: 20px; height: 20px;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        #custom-cursor .crosshair { 
            stroke: var(--color-primary); 
            stroke-width: 1.5px; 
            animation: cursor-spin 10s linear infinite; 
        }
        body.color-shift-active #custom-cursor .crosshair {
            animation: cursor-spin 10s linear infinite, color-shift-stroke 8s infinite linear; 
        }
        @keyframes cursor-spin { 100% { transform: rotate(360deg); } }

        @keyframes color-shift {
            0%, 100% {
                border-color: var(--color-shift-primary);
                color: var(--color-shift-primary);
            }
            33% {
                border-color: var(--color-shift-secondary);
                color: var(--color-shift-secondary);
            }
            66% {
                border-color: var(--color-shift-tertiary);
                color: var(--color-shift-tertiary);
            }
        }
        
        @keyframes color-shift-stroke {
             0%, 100% { stroke: var(--color-shift-primary); }
             33% { stroke: var(--color-shift-secondary); }
             66% { stroke: var(--color-shift-tertiary); }
        }
        
        @keyframes color-shift-bg {
             0%, 100% { background-color: var(--color-shift-primary); }
             33% { background-color: var(--color-shift-secondary); }
             66% { background-color: var(--color-shift-tertiary); }
        }

        .ui-box {
            border: 1px solid var(--color-border);
            background: rgba(10, 10, 10, 0.7);
            padding: 1rem;
            position: relative;
            backdrop-filter: blur(8px);
        }
        .ui-box::before, .ui-box::after, .ui-box .corner-bl, .ui-box .corner-br {
            content: ''; position: absolute; width: 10px; height: 10px; border: 2px solid var(--color-primary);
        }
        body.color-shift-active .ui-box::before, body.color-shift-active .ui-box::after, body.color-shift-active .ui-box .corner-bl, body.color-shift-active .ui-box .corner-br {
            animation: color-shift 8s infinite ease-in-out;
        }
        .ui-box::before { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .ui-box::after { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .ui-box .corner-bl { bottom: -2px; left: -2px; border-top: none; border-right: none; }
        .ui-box .corner-br { bottom: -2px; right: -2px; border-top: none; border-left: none; }
        
        #boot-container { position: fixed; inset: 0; z-index: 100; }
        .boot-stage { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; }
        .boot-stage.active { opacity: 1; visibility: visible; }
        
        .stage-title { position: absolute; top: 2rem; left: 50%; transform: translateX(-50%); font-family: var(--font-primary); font-size: 1.5rem; letter-spacing: 5px; color: var(--color-primary); }
        body.color-shift-active .stage-title { animation: color-shift 8s infinite linear; }
        
        #stage-offline-text { z-index: 10; text-align: center; }
        #stage-offline h1 { font-size: 2rem; letter-spacing: 4px; color: var(--color-primary); }
        body.color-shift-active #stage-offline h1 { animation: color-shift 8s infinite linear; }
        #stage-offline p { font-size: 1.2rem; margin-top: 1rem; color: var(--color-warning); animation: slow-blink 2s infinite; }
        @keyframes slow-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .canvas-container { position: absolute; inset: 0; width: 100%; height: 100%; }
        .canvas-container canvas { width: 100%; height: 100%; display: block; }

        #bios-container { width: 95vw; max-width: 1800px; height: 95vh; display: flex; flex-direction: column; gap: 1rem; }
        #bios-content { display: grid; grid-template-columns: 3fr 2fr; gap: 1rem; flex-grow: 1; overflow: hidden;}
        #bios-lines-box { display: flex; flex-direction: column; overflow: hidden; }
        #bios-lines { flex-grow: 1; overflow-y: scroll; font-size: 0.8rem; padding: 1rem; }
        .bios-line { white-space: pre-wrap; margin-bottom: 0.25rem; }
        .keyword-ok { color: var(--color-ok); font-weight: bold; }
        .keyword-error { color: var(--color-primary); font-weight: bold; animation: fast-blink 0.5s infinite; }
        .keyword-warn { color: var(--color-warning); }
        .keyword-info { color: var(--color-info); }
        .keyword-sys { color: #a855f7; }
        .keyword-data { color: #fb923c; }
        .highlight { background: var(--color-border); padding: 0 4px; }
        @keyframes fast-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        #bios-sidebar { display: flex; flex-direction: column; gap: 1rem; }
        .progress-bar-container { border: 1px solid var(--color-border); padding: 2px; margin-top: 0.25rem; background: rgba(0,0,0,0.2); }
        .progress-bar { width: 0%; height: 10px; background: var(--color-primary); transition: width 0.1s linear, background-color 0.5s linear; }
        body.color-shift-active .progress-bar { animation: color-shift-bg 8s infinite linear; }
        .progress-label { margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }
        
        .circular-bars-container { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 1rem; margin-top: 1rem; }
        .circular-bar { position: relative; width: 100%; padding-top: 100%; }
        .circular-bar svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .circular-bar circle { fill: none; stroke-width: 8; }
        .circular-bar .bar-bg { stroke: var(--color-border); }
        .circular-bar .bar-fg { stroke: var(--color-primary); stroke-linecap: round; transition: stroke-dashoffset 0.2s linear; }
        body.color-shift-active .circular-bar .bar-fg { animation: color-shift-stroke 8s infinite linear; }
        .circular-bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        #bios-sidebar-visual { flex-grow: 1; margin-top: 1rem; position: relative; }

        .animated-title {
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary), var(--color-tertiary), var(--color-primary));
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-scroll 6s linear infinite;
        }
        @keyframes gradient-scroll {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        #auth-title { font-family: var(--font-primary); font-size: 2rem; margin-bottom: 2rem; }
        #login-form { width: 400px; }
        .input-field { background: transparent; border: none; border-bottom: 2px solid var(--color-border); width: 100%; padding: 0.5rem 0; font-size: 1.2rem; margin-bottom: 2rem; }
        .input-field:focus { outline: none; border-bottom-color: var(--color-primary); }
        body.color-shift-active .input-field:focus { animation: color-shift 8s infinite linear; }
        .login-btn { font-size: 1.2rem; font-weight: 700; padding: 0.75rem; background: transparent; border: 2px solid var(--color-primary); width: 100%; transition: all 0.3s; }
        body.color-shift-active .login-btn { animation: color-shift 8s infinite linear reverse; }
        .login-btn:hover { background: var(--color-primary); color: var(--color-bg); animation-play-state: paused; }
        #login-error { color: var(--color-primary); text-align: center; margin-top: 1rem; display: none; }

        /* C3I Application Styles */
        #desktop { display: none; height: 100vh; }
        .main-grid { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: 1fr; height: 100%; gap: 1rem; padding: 2rem; transition: grid-template-columns 0.3s ease-in-out; }
        .main-grid.collapsed { grid-template-columns: 60px 1fr; }

        #main-nav .nav-text { transition: opacity 0.2s ease, width 0.2s ease; width: auto; white-space: nowrap; }
        .main-grid.collapsed #main-nav .nav-text { opacity: 0; pointer-events: none; width: 0; }
        .main-grid.collapsed #main-nav h1 { font-size: 1.5rem; text-align: center; }
        .main-grid.collapsed #main-nav .nav-item { 
            justify-content: center; 
            gap: 0;
            padding-left: 0;
            padding-right: 0;
        }

        .nav-item { transition: all 0.3s ease; cursor: pointer; }
        .nav-item .icon-box { background-color: rgba(255,255,255,0.05); border: 1px solid var(--color-border); transition: all 0.3s ease; }
        .nav-item:hover .icon-box { background-color: var(--color-border); }
        .nav-item.active .icon-box { 
            background-color: var(--color-primary); 
            color: var(--color-bg); 
            border-color: var(--color-primary);
        }

        #sidebar-toggle { transition: transform 0.3s ease-in-out; }
        .main-grid.collapsed #sidebar-toggle { transform: rotate(180deg); }

        #tactical-map-container, #map-plane-container { position: relative; width: 100%; height: 100%; }
        #tactical-map, #map-plane { width: 100%; height: 100%; cursor: grab; }
        #tactical-map:active, #map-plane:active { cursor: grabbing; }

        .asset-icon { position: absolute; color: var(--color-primary); transform: translate(-50%, -50%); cursor: pointer; font-size: 24px; }
        .asset-icon:hover .tooltip { display: block; }
        .tooltip { display: none; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: rgba(10,10,10,0.9); padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1100; }
        .c3i-input, .c3i-select, .c3i-textarea, .c3i-button { background-color: rgba(255, 60, 60, 0.1); border: 1px solid var(--color-border); padding: 0.5rem; border-radius: 0px; color: var(--color-text); }
        .c3i-button { cursor: pointer; transition: all 0.2s ease; }
        .c3i-button:hover { background-color: rgba(255, 60, 60, 0.3); border-color: var(--color-primary); }
        .c3i-button:disabled { cursor: not-allowed; opacity: 0.5; }

        .text-primary { color: var(--color-primary); }
        body.color-shift-active .text-primary { animation: color-shift 8s infinite linear; }
        .text-ok { color: var(--color-ok); }
        .text-warning { color: var(--color-warning); }
        .text-secondary { color: var(--color-secondary); }
        .text-info { color: var(--color-info); }

        .control-toggle { display: flex; align-items: center; justify-content: space-between; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 4px; bottom: 4px; background-color: var(--color-text); transition: .4s; }
        input:checked + .slider { background-color: var(--color-primary); }
        body.color-shift-active input:checked + .slider { animation: color-shift-bg 8s infinite linear; }
        input:checked + .slider:before { transform: translateX(20px); }

        .theme-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid var(--color-border); transition: all 0.2s; }
        .theme-btn.active { border-color: var(--color-primary); transform: scale(1.1); }

        .sidebar-tab { padding: 0.5rem; border-bottom: 2px solid transparent; cursor: pointer; }
        .sidebar-tab.active { border-bottom-color: var(--color-primary); color: var(--color-primary); }
        body.color-shift-active .sidebar-tab.active { animation: color-shift 8s infinite linear; }
        .sidebar-tab-content { display: none; }
        .sidebar-tab-content.active { display: block; }

        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; height: 30px; padding: 0; border: 1px solid var(--color-border); background-color: transparent; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        .waypoint-2d {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--color-warning);
            border: 2px solid var(--color-text);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 8px var(--color-warning);
        }

        @keyframes status-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #status-text {
            animation: status-pulse 3s infinite ease-in-out;
        }

        /* Intel/Codex/Armoury Page Specific Styles */
        .data-nav-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .data-nav-item:hover {
            background-color: var(--color-border);
        }
        .data-nav-item.active {
            color: var(--color-primary);
            background-color: var(--color-border);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            border: 1px solid var(--color-border);
            padding: 0.5rem;
            text-align: left;
        }
        .data-table th {
            background-color: rgba(255,255,255,0.05);
            color: var(--color-primary);
        }
        #codex-content-container h3, #armoury-detail-wrapper h3, #weapons-detail-view h3, #ammo-detail-view h3 {
            font-size: 1.25rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        #codex-content-container h4, #armoury-detail-wrapper h4, #weapons-detail-view h4, #ammo-detail-view h4 {
            font-size: 1.1rem;
            color: var(--color-secondary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #codex-content-container ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        
        /* Armoury Stat Bars */
        .stat-bar { background-color: var(--color-border); height: 10px; width: 100%; }
        .stat-bar-inner { height: 100%; transition: width 0.5s ease-out; }
        .stat-bar-offense { background-color: var(--color-primary); }
        .stat-bar-defense { background-color: var(--color-info); }
        .stat-bar-propulsion { background-color: var(--color-ok); }
        
        .border-l-ally { border-left-color: var(--color-ally) !important; }
        .border-l-hostile { border-left-color: var(--color-primary) !important; }
        .border-l-neutral { border-left-color: #f5a623 !important; } /* Yellow */
        .border-l-caution { border-left-color: #ff8c3c !important; } /* Orange-Red */
        .border-l-avoid { border-left-color: var(--color-tertiary) !important; }
    </style>
</head>
<body class="theme-crimson color-shift-active">

    <div id="custom-cursor"><svg class="crosshair" width="20" height="20" viewBox="0 0 24 24" style="transform-origin: center;"><path d="M12 2 L12 5 M12 19 L12 22 M2 12 L5 12 M19 12 L22 12" fill="none" /></svg></div>
    <div id="noise-overlay"></div>

    <div id="boot-container">
        <!-- Stages 0-5 for boot sequence -->
        <div id="stage-offline" class="boot-stage active"><div id="stage-offline-text"><h1>SYSTEM OFFLINE</h1><p>STATUS: IDLE</p><p class="text-sm mt-8 text-gray-500">CLICK OR PRESS ANY KEY TO INITIATE BOOT</p></div><div class="canvas-container" id="offline-canvas-container"><canvas id="offline-canvas"></canvas></div></div>
        <div id="stage-core-ignition" class="boot-stage"><div class="stage-title">SYSTEM CORE IGNITION</div><div class="canvas-container" id="core-ignition-canvas-container"><canvas id="core-ignition-canvas"></canvas></div></div>
        <div id="stage-bios" class="boot-stage"><div id="bios-container"><div class="ui-box self-start"><h1 class="text-base font-bold tracking-widest animated-title">WARSAT BIOS v28.01</h1></div><div id="bios-content"><div id="bios-lines-box" class="ui-box"><div id="bios-lines"></div></div><div id="bios-sidebar" class="flex flex-col gap-4"><div class="ui-box flex-grow"><div class="progress-label">QEC Integrity</div><div class="progress-bar-container"><div id="bar-qec" class="progress-bar"></div></div><div class="progress-label mt-2">Heatsink Calibration</div><div class="progress-bar-container"><div id="bar-heat" class="progress-bar"></div></div><div class="progress-label mt-2">Weapon Systems</div><div class="progress-bar-container"><div id="bar-wpn" class="progress-bar"></div></div><div class="progress-label mt-2">Telemetry Link</div><div class="progress-bar-container"><div id="bar-telemetry" class="progress-bar"></div></div><div class="progress-label mt-2">Shield Emitters</div><div class="progress-bar-container"><div id="bar-shield" class="progress-bar"></div></div><div class="progress-label mt-2">Sensor Array</div><div class="progress-bar-container"><div id="bar-sensor" class="progress-bar"></div></div><div class="circular-bars-container mt-4"><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-power" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">Power</div></div><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-nav" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">NAV</div></div><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-life" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">Life</div></div><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-cpu" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">CPU</div></div><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-mem" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">MEM</div></div><div class="circular-bar"><svg viewBox="0 0 100 100"><circle class="bar-bg" cx="50" cy="50" r="45"></circle><circle id="cbar-net" class="bar-fg" cx="50" cy="50" r="45"></circle></svg><div class="circular-bar-label">NET</div></div></div><div id="bios-sidebar-visual"></div></div></div></div></div></div>
        <div id="stage-threat-analysis" class="boot-stage"><div class="stage-title">THREAT ANALYSIS</div><div class="canvas-container" id="threat-analysis-canvas-container"><canvas id="threat-analysis-canvas"></canvas></div></div>
        <div id="stage-auth" class="boot-stage"><div class="ui-box"><h1 id="auth-title" class="animated-title">[SYSTEM ONLINE]</h1><form id="login-form"><input type="text" id="username" class="input-field" placeholder="CODENAME" required autocomplete="off"><input type="password" id="password" class="input-field" placeholder="PASSCODE" required autocomplete="off"><button type="submit" class="login-btn">AUTHORIZE</button><p id="login-error">AUTH FAILED: INVALID CREDENTIALS</p></form></div></div>
        <div id="stage-lockdown" class="boot-stage"><div class="text-center"><h1 class="text-5xl text-primary font-bold">!!! INTRUSION DETECTED !!!</h1><p class="text-2xl mt-4 text-warning">ACCESS DENIED. USER FLAGGED AS TRAITOR.</p><p class="mt-8">SYSTEM LOCKDOWN INITIATED. AUTHORITIES HAVE BEEN NOTIFIED.</p></div></div>
    </div>
    
    <!-- Final "desktop" screen after successful login -->
    <div id="desktop">
        <main id="main-interface" class="main-grid">
            <!-- Navigation -->
            <nav id="main-nav" class="ui-box p-4 flex flex-col">
                <h1 class="font-bold text-2xl text-primary mb-4 transition-all nav-text">HELIOS</h1>
                <div class="flex-grow space-y-2">
                    <div data-page="map" class="nav-item p-2 flex items-center gap-4 active"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></div><span class="nav-text">Tactical Map</span></div>
                    <div data-page="armoury" class="nav-item p-2 flex items-center gap-4"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3A2 2 0 0 0 6.9 2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16z"></path></svg></div><span class="nav-text">Armoury</span></div>
                    <div data-page="codex" class="nav-item p-2 flex items-center gap-4"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg></div><span class="nav-text">Codex</span></div>
                    <div data-page="intel" class="nav-item p-2 flex items-center gap-4"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></div><span class="nav-text">Intel</span></div>
                    <div data-page="comms" class="nav-item p-2 flex items-center gap-4"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div><span class="nav-text">Communications</span></div>
                    <div data-page="settings" class="nav-item p-2 flex items-center gap-4"><div class="icon-box p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg></div><span class="nav-text">Settings</span></div>
                </div>
                <div id="user-info" class="text-center border-t border-primary/20 pt-2 mt-auto">
                    <p id="user-callsign" class="font-bold nav-text"></p>
                    <p id="user-clearance" class="text-primary nav-text"></p>
                    <button id="logout-button" class="w-full mt-2 text-sm c3i-button nav-text">Logout</button>
                    <div id="sidebar-toggle" class="mt-2 text-center cursor-pointer hover:text-primary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-left mx-auto"><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></svg></div>
                </div>
            </nav>

            <!-- Main Content Container -->
            <div id="desktop-content-container" class="ui-box h-full overflow-hidden p-0 flex flex-col">
                <!-- Page content will be injected here -->
            </div>
        </main>
    </div>

    <!-- Page Templates -->
    <template id="template-map">
        <div class="h-full flex flex-col relative p-0">
             <div id="map-main-panel" class="absolute inset-0">
                 <div id="tactical-map-container" class="w-full h-full">
                     <canvas id="tactical-map"></canvas>
                 </div>
             </div>
             <div class="absolute top-4 left-4 w-64 ui-box">
                 <h3 class="text-lg text-primary mb-2">Globe Controls</h3>
                 <div class="space-y-2 text-sm">
                     <div class="control-toggle"><span>Auto-Rotate</span><label class="toggle-switch"><input type="checkbox" id="rotate-toggle" checked><span class="slider"></span></label></div>
                     <div class="control-toggle"><span>Height Map</span><label class="toggle-switch"><input type="checkbox" id="heightmap-toggle"><span class="slider"></span></label></div>
                     <div class="control-toggle"><span>Territory</span><label class="toggle-switch"><input type="checkbox" id="territory-toggle"><span class="slider"></span></label></div>
                     <div class="control-toggle"><span>Resources</span><label class="toggle-switch"><input type="checkbox" id="resources-toggle"><span class="slider"></span></label></div>
                     <div class="control-toggle"><span>Coordinates</span><label class="toggle-switch"><input type="checkbox" id="coord-toggle"><span class="slider"></span></label></div>
                 </div>
             </div>
              <div class="absolute top-4 right-4 w-80 ui-box max-h-[calc(100%-2rem)] flex flex-col">
                 <div class="flex border-b border-primary/20 mb-2">
                     <div class="sidebar-tab active" data-tab="waypoints">Waypoints</div>
                 </div>
                 <div class="flex-grow overflow-y-auto no-scrollbar">
                     <div class="sidebar-tab-content active" id="tab-content-waypoints">
                         <div id="waypoint-list"></div>
                         <div id="waypoint-info-content"><p class="text-sm text-gray-500">Right-click map to plot or select a waypoint.</p></div>
                     </div>
                 </div>
             </div>
             <div class="absolute bottom-4 left-4 w-64 ui-box">
                 <h3 class="text-lg text-primary mb-2">STATUS</h3>
                 <p id="status-text" class="text-sm"></p>
             </div>
        </div>
    </template>

    <template id="template-armoury">
        <div id="armoury-page-wrapper" class="h-full flex flex-col p-4">
            <h2 class="text-xl text-primary border-b border-primary/20 pb-4">Armoury & Weapon Systems</h2>
            <div class="flex border-b border-primary/20 mt-4">
                <div class="sidebar-tab active" data-tab="assets">Asset Browser</div>
                <div class="sidebar-tab" data-tab="weapons">Weapons</div>
                <div class="sidebar-tab" data-tab="ammunition">Ammunition</div>
                <div class="sidebar-tab" data-tab="penetration">Penetration Sim</div>
            </div>
            <div class="flex-grow mt-4 overflow-hidden">
                <div id="armoury-content-assets" class="sidebar-tab-content active h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                        <div id="armoury-nav-container" class="ui-box col-span-1 flex flex-col h-full">
                            <div id="armoury-breadcrumbs" class="text-sm text-gray-400 mb-2"></div>
                            <div id="armoury-file-list" class="flex-grow overflow-y-auto"></div>
                        </div>
                        <div id="armoury-detail-wrapper" class="ui-box col-span-2 overflow-y-auto h-full">
                             <div id="armoury-detail-content">
                                 <p class="text-gray-500">Select an asset to view details.</p>
                             </div>
                             <div id="armoury-comparison-wrapper" class="mt-4">
                                 <div class="flex justify-between items-center mb-2">
                                     <h4 class="text-secondary">Comparison</h4>
                                     <button id="clear-comparison-btn" class="c3i-button text-xs">Clear</button>
                                 </div>
                                 <div id="armoury-comparison-grid">
                                     <p class="text-gray-500 text-xs">Add up to 3 assets to compare.</p>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
                <div id="armoury-content-weapons" class="sidebar-tab-content h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                        <div id="weapons-list-container" class="col-span-1 ui-box overflow-y-auto"></div>
                        <div id="weapons-detail-view" class="col-span-2 ui-box overflow-y-auto">
                            <p class="text-gray-500">Select a weapon system to view details.</p>
                        </div>
                    </div>
                </div>
                <div id="armoury-content-ammunition" class="sidebar-tab-content h-full">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                         <div id="ammo-list-container" class="col-span-1 ui-box overflow-y-auto"></div>
                         <div id="ammo-detail-view" class="col-span-2 ui-box overflow-y-auto">
                             <p class="text-gray-500">Select an ammunition type to view details.</p>
                         </div>
                    </div>
                </div>
                <div id="armoury-content-penetration" class="sidebar-tab-content h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                        <div class="col-span-1 ui-box overflow-y-auto" id="penetration-controls">
                            <!-- Penetration Sim Controls will be injected here -->
                        </div>
                        <div class="col-span-2 ui-box p-0 relative" id="penetration-visual-container">
                            <!-- Penetration Sim 3D view will be here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-codex">
        <div class="h-full flex flex-col p-4">
            <h2 class="text-xl text-primary border-b border-primary/20 pb-4">Codex - Field Manual & Regulations</h2>
            <div class="grid grid-cols-4 gap-4 mt-4 flex-grow overflow-hidden">
                <div id="codex-nav" class="col-span-1 ui-box overflow-y-auto">
                    <!-- Navigation items will be populated by JS -->
                </div>
                <div id="codex-content-container" class="col-span-3 ui-box overflow-y-auto pr-2">
                    <!-- Codex content will be injected here -->
                </div>
            </div>
        </div>
    </template>

    <template id="template-intel">
         <div id="intel-page-wrapper" class="h-full flex flex-col p-4">
             <h2 class="text-xl text-primary border-b border-primary/20 pb-4">Intelligence Database</h2>
             <div class="flex border-b border-primary/20 mt-4">
                 <div class="sidebar-tab active" data-tab="factions">Factions</div>
                 <div class="sidebar-tab" data-tab="plans">Plans</div>
                 <div class="sidebar-tab" data-tab="tasks">Tasks</div>
                 <div class="sidebar-tab" data-tab="personnel">Personnel</div>
             </div>
             <div id="intel-content-container" class="flex-grow mt-4 overflow-hidden">
                 <div id="intel-factions" class="sidebar-tab-content active h-full">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                         <div id="faction-list-container" class="col-span-1 ui-box overflow-y-auto"></div>
                         <div id="faction-detail-view" class="col-span-2 ui-box overflow-y-auto">
                             <p class="text-gray-500">Select a faction to view details.</p>
                         </div>
                     </div>
                 </div>
                 <div id="intel-plans" class="sidebar-tab-content h-full">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                         <div id="plan-list-container" class="col-span-1 ui-box overflow-y-auto"></div>
                         <div id="plan-detail-view" class="col-span-2 ui-box overflow-y-auto">
                             <p class="text-gray-500">Select a plan to view details or create a new one.</p>
                         </div>
                     </div>
                 </div>
                 <div id="intel-tasks" class="sidebar-tab-content h-full">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">
                         <div id="task-list-container" class="col-span-1 ui-box overflow-y-auto"></div>
                         <div id="task-detail-view" class="col-span-2 ui-box overflow-y-auto">
                             <p class="text-gray-500">Select a task to view details or create a new one.</p>
                         </div>
                     </div>
                 </div>
                 <div id="intel-personnel" class="sidebar-tab-content h-full overflow-y-auto">
                     <div id="personnel-container" class="p-4"></div>
                 </div>
             </div>
         </div>
    </template>
    
    <template id="template-comms">
        <div class="h-full flex flex-col p-4">
            <h2 class="text-xl text-primary border-b border-primary/20 pb-4">Communications - Channel 7 [OFFLINE]</h2>
            <div id="chat-messages" class="flex-grow my-4 overflow-y-auto pr-2 flex items-center justify-center">
                <p class="text-gray-500">NETWORK CONNECTION SEVERED. COMMS OFFLINE.</p>
            </div>
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" class="c3i-input flex-grow" placeholder="TRANSMISSION FAILED..." disabled>
                <button type="submit" class="c3i-button" disabled>Send</button>
            </form>
        </div>
    </template>

    <template id="template-settings">
        <div class="h-full flex flex-col p-4">
            <h2 class="text-xl text-primary border-b border-primary/20 pb-4">System Settings</h2>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow overflow-y-auto pr-2">
                <div class="ui-box">
                    <h3 class="text-lg text-primary mb-2">Audio</h3>
                    <div class="control-toggle">
                        <span>Enable UI Sounds</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="ui-box">
                    <h3 class="text-lg text-primary mb-2">Visual Theme</h3>
                     <div id="theme-selector" class="flex flex-wrap gap-4 mt-2">
                         <button class="theme-btn" data-theme="theme-crimson" style="background-color: #DC143C;"></button>
                         <button class="theme-btn" data-theme="theme-helios" style="background-color: #9cd4c4;"></button>
                         <button class="theme-btn" data-theme="theme-cobalt" style="background-color: #1976D2;"></button>
                         <button class="theme-btn" data-theme="theme-hunter" style="background-color: #2E7D32;"></button>
                         <button class="theme-btn" data-theme="theme-amber" style="background-color: #FFA000;"></button>
                         <button class="theme-btn" data-theme="theme-orion" style="background-color: #4A90E2;"></button>
                         <button class="theme-btn" data-theme="theme-void" style="background-color: #9C27B0;"></button>
                         <button class="theme-btn" data-theme="theme-plasma" style="background-color: #00FF00;"></button>
                         <button class="theme-btn" data-theme="theme-sunset" style="background-color: #FF4500;"></button>
                         <button class="theme-btn" data-theme="theme-glacial" style="background-color: #FFFFFF;"></button>
                     </div>
                </div>
                 <div class="ui-box">
                    <h3 class="text-lg text-primary mb-2">Effects</h3>
                    <div class="control-toggle">
                        <span>Color Shift UI</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="color-shift-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="color-shift-options" class="mt-4 space-y-2 text-sm">
                        <div>
                            <label for="primary-shift-color">Primary Shift</label>
                            <input type="color" id="primary-shift-color" class="w-full h-8">
                        </div>
                        <div>
                            <label for="secondary-shift-color">Secondary Shift</label>
                            <input type="color" id="secondary-shift-color" class="w-full h-8">
                        </div>
                        <div>
                            <label for="tertiary-shift-color">Tertiary Shift</label>
                            <input type="color" id="tertiary-shift-color" class="w-full h-8">
                        </div>
                    </div>
                </div>
                <div class="ui-box md:col-span-2">
                    <h3 class="text-lg text-primary mb-2">System Audit Log (Session Only)</h3>
                    <div id="audit-log-container" class="mt-4 overflow-y-auto max-h-96"></div>
                </div>
            </div>
        </div>
    </template>
    
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Three.js Imports ---
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Global State ---
        const c3iState = {
            currentUser: null, // This will be the selected profile, not the auth user
            waypoints: [],
            auditLog: [],
            intel: {
                factions: {},
                plans: [],
                tasks: [],
                users: {}
            },
            armoury: {},
            codex: {},
            weaponSystems: {
                weapons: [],
                ammo: [],
                armor: {},
            },
            comparisonAssets: [],
            assetClasses: {},
            settings: {}, // User-specific settings
        };

        const bootState = {
            stages: null,
            cursor: null,
            loginForm: null,
            loginError: null,
            mousePos: { x: 0, y: 0 },
            currentStage: 0,
            soundInitialized: false,
            uiSynth: null, failSynth: null, successSynth: null, deploySynth: null, matrixSynth: null, flowSynth: null,
            threeInstances: []
        };
        
        // --- Firebase State ---
        let db, auth, userId, appId;
        let unsubscribeListeners = []; // To store unsubscribe functions for cleanup

        // --- Firestore Initialization and Seeding ---
        async function initFirebase() {
            // User-provided Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyBXeJG9xc2xQCoCzKX6WATwSW2CulOre3E",
                authDomain: "helios-interface.firebaseapp.com",
                projectId: "helios-interface",
                storageBucket: "helios-interface.appspot.com",
                messagingSenderId: "1073548914126",
                appId: "1:1073548914126:web:ec04b501ba577b08584f9f",
                measurementId: "G-65W3XRX32Y"
            };

            // Use the projectId for database paths, as it's a valid segment.
            appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
            if (!appId) {
                console.error("App ID/Project ID is missing.");
                 const offlineText = document.getElementById('stage-offline-text');
                if(offlineText) {
                    offlineText.innerHTML = `<h1>CRITICAL ERROR</h1><p>FIREBASE PROJECT ID MISSING</p>`;
                }
                return false;
            }

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // For detailed console logs

            // Sign in the user
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication Failed:", error);
                const offlineText = document.getElementById('stage-offline-text');
                 if(offlineText) {
                    offlineText.innerHTML = `<h1>AUTHENTICATION FAILED</h1><p>${error.message}</p>`;
                }
                return false;
            }

            return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                        
                        // Check if data needs to be seeded
                        await seedInitialData();
                        
                        // Load all necessary data from Firestore
                        await loadAllData();

                        resolve(true);
                    } else {
                        console.log("User is signed out.");
                        resolve(false);
                    }
                });
            });
        }

        async function seedInitialData() {
            const seedFlagRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'seedStatus');
            const seedFlagDoc = await getDoc(seedFlagRef);

            if (seedFlagDoc.exists() && seedFlagDoc.data().seeded_v2) {
                console.log("Initial data already seeded.");
                return;
            }

            console.log("Seeding initial data to Firestore...");
            const batch = writeBatch(db);
            
            // --- DATA TO SEED ---
            const initialData = getInitialDataObject();

            // Seed Factions
            Object.entries(initialData.intel.factions).forEach(([key, value]) => {
                const docRef = doc(db, `artifacts/${appId}/public/data/factions`, key);
                batch.set(docRef, value);
            });

            // Seed Codex
            Object.entries(initialData.codex).forEach(([key, value]) => {
                const docRef = doc(db, `artifacts/${appId}/public/data/codex`, key);
                batch.set(docRef, { content: value });
            });

            // Seed Armoury
            const armouryRef = doc(db, `artifacts/${appId}/public/data/armoury`, 'main');
            batch.set(armouryRef, initialData.armoury);

            // Seed Asset Classes
            const assetClassesRef = doc(db, `artifacts/${appId}/public/data/assetClasses`, 'main');
            batch.set(assetClassesRef, initialData.assetClasses);

            // Seed Weapon Systems
            const weaponsRef = doc(db, `artifacts/${appId}/public/data/weaponSystems`, 'main');
            batch.set(weaponsRef, initialData.weaponSystems);
            
            // Seed User Profiles
            Object.entries(initialData.intel.users).forEach(([key, value]) => {
                const docRef = doc(db, `artifacts/${appId}/public/data/users`, key);
                batch.set(docRef, value);
            });

            // Set the seed flag
            batch.set(seedFlagRef, { seeded_v2: true, timestamp: new Date() });

            try {
                await batch.commit();
                console.log("Initial data successfully seeded.");
            } catch (error) {
                console.error("Error seeding data:", error);
            }
        }
        
        // --- DATA LOADING ---
        async function loadAllData() {
            console.log("Loading all data from Firestore...");
            const dataPromises = [
                loadCollection('factions', c3iState.intel.factions),
                loadCollection('codex', c3iState.codex, (doc) => doc.data().content),
                loadDoc('armoury', 'main', c3iState, 'armoury'),
                loadDoc('assetClasses', 'main', c3iState, 'assetClasses'),
                loadDoc('weaponSystems', 'main', c3iState, 'weaponSystems'),
                loadCollection('users', c3iState.intel.users),
                loadUserSettings()
            ];
            await Promise.all(dataPromises);
            console.log("All data loaded.", c3iState);
        }

        async function loadCollection(collectionName, targetObject, dataExtractor = (doc) => doc.data()) {
            const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            const querySnapshot = await getDocs(collectionRef);
            querySnapshot.forEach(doc => {
                targetObject[doc.id] = dataExtractor(doc);
            });
        }

        async function loadDoc(collectionName, docId, targetObject, targetKey) {
            const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                targetObject[targetKey] = docSnap.data();
            } else {
                console.warn(`Document ${docId} not found in ${collectionName}`);
            }
        }
        
        async function loadUserSettings() {
            const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/userSettings`);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                c3iState.settings = docSnap.data();
                applyUserSettings(c3iState.settings);
            } else {
                // Set default settings if none exist
                c3iState.settings = {
                    theme: 'theme-crimson',
                    colorShift: true,
                    sound: true,
                    shiftColors: {
                        primary: '#ff3c3c',
                        secondary: '#ff8c3c',
                        tertiary: '#9C27B0'
                    }
                };
            }
        }
        
        function applyUserSettings(settings) {
            // Apply theme
             if(settings.theme) {
                document.body.className = settings.colorShift ? `${settings.theme} color-shift-active` : settings.theme;
             }
             // Apply color shift colors
             if (settings.shiftColors) {
                document.body.style.setProperty('--color-shift-primary', settings.shiftColors.primary);
                document.body.style.setProperty('--color-shift-secondary', settings.shiftColors.secondary);
                document.body.style.setProperty('--color-shift-tertiary', settings.shiftColors.tertiary);
             }
             // Apply sound setting
             if (bootState.soundInitialized) {
                 Tone.getDestination().mute = !settings.sound;
             }
        }

        // --- DATA PERSISTENCE ---
        async function saveUserSettings() {
            if (!userId) return;
            const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/userSettings`);
            try {
                await setDoc(settingsRef, c3iState.settings, { merge: true });
                console.log("Settings saved.");
            } catch (error) {
                console.error("Error saving settings: ", error);
            }
        }
        
        function setupRealtimeListeners() {
            // Clear any existing listeners
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            // Waypoints listener
            const waypointsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/waypoints`));
            const unsubWaypoints = onSnapshot(waypointsQuery, (snapshot) => {
                c3iState.waypoints = [];
                snapshot.forEach(doc => {
                    c3iState.waypoints.push({ id: doc.id, ...doc.data() });
                });
                window.dispatchEvent(new CustomEvent('waypointsUpdated'));
            });
            unsubscribeListeners.push(unsubWaypoints);
            
            // Plans listener
            const plansQuery = query(collection(db, `artifacts/${appId}/users/${userId}/plans`));
            const unsubPlans = onSnapshot(plansQuery, (snapshot) => {
                c3iState.intel.plans = [];
                snapshot.forEach(doc => {
                    c3iState.intel.plans.push({ id: doc.id, ...doc.data() });
                });
                window.dispatchEvent(new CustomEvent('plansUpdated'));
            });
            unsubscribeListeners.push(unsubPlans);
            
            // Tasks listener
            const tasksQuery = query(collection(db, `artifacts/${appId}/users/${userId}/tasks`));
            const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
                c3iState.intel.tasks = [];
                snapshot.forEach(doc => {
                    c3iState.intel.tasks.push({ id: doc.id, ...doc.data() });
                });
                window.dispatchEvent(new CustomEvent('tasksUpdated'));
            });
            unsubscribeListeners.push(unsubTasks);
        }

        // --- Initial Data Object (for seeding) ---
        function getInitialDataObject() {
             const ammoCsvData = `Ammo Round Name,Base Damage,Mass (kg),Max Trajectory (m),Area of Damage (Radius / Damage),Fragments (Type / Count)
HE (4.5 Inch),500,10,5000,"5m / 100",HEPDShrap / 50
HE-VT (4.5 Inch),500,10,5000,"5m / 100",HEPDShrap / 50
HC Mark 41 (5 Inch),600,12,5000,"5m / 100",HEPDShrap / 50
HC-VT Mark 41 (5 Inch),600,12,5000,"5m / 100",HEPDShrap / 50
HE-PD (5 Inch),550,11,4000,"5m / 5",HEPDShrap / 50
HE-MOM (76mm),400,8,5000,"5m / 100",HEPDShrap / 40
HE (100mm),450,9,5000,"5m / 100",HEPDShrap / 40
120mm HE,700,15,5000,"5m / 100",HEPDShrap / 50
8 Inch HC Mark 25,2500,118,5500,"10m / 25",HEPDShrap / 30
12 Inch AP Mk 16 (US),5000,450,7000,"5m / 5",6InchShrap / 35
12 Inch HE Mk 16 (US),3500,400,6500,"10m / 25",6InchShrap / 30
12 Inch HE (US),3500,400,6500,"10m / 25",6InchShrap / 30
Bofors 254mm HE,3000,250,6000,"5m / 5",6InchShrap / 30
380mm SAP (OTO),4000,350,7000,"5m / 5",380mmShrap / 45
12 Inch AP (UK),5200,480,7000,"5m / 5",6InchShrap / 35
12 Inch HE (UK),3600,420,6500,"10m / 25",6InchShrap / 30
127mm Hvar Rocket,200,18,3800,None,None
13mm,20,0.05,1000,None,None
37mm Shell,50,0.7,1000,"5m / 5",37mmShrap / 20
37mm,50,0.7,1000,"5m / 5",37mmShrap / 20`;

            const weaponsCsvData = `Weapon Name,Rate of Fire (RPM),Reload Time (seconds),Max Target Distance (m),Weapon Type,Ammunition,Ammo Magazine
100mm MLE 1968,80,1,7000,BlockWeapon,"HE (100mm)",Fam_100mm_HE_FR
120mm TAK120,80,1,7000,BlockWeapon,"120mm HE",Fam_120mm_HE_Sweden
76mm 62 SR,120,6,7000,BlockWeapon,"HE-MOM (76mm)",Fam_76mm_HE_IT
4.5 Inch Mark V,24,0.4,7000,BlockWeapon,"HE (4.5 Inch),HE-VT (4.5 Inch)",Fam_4_5_Shell_UK
5 Inch 54 Mark 42,34,2,7000,BlockWeapon,"HC Mark 41 (5 Inch),HC-VT Mark 41 (5 Inch)",Fam5InchShell_US
5 Inch 64 LW,32,0.5,7000,BlockWeapon,"HE-PD (5 Inch)",Fam5InchShell
8 Inch 55 Mark 71,12,5,7000,BlockWeapon,"8 Inch HC Mark 25",Fam8InchShell
12 Inch 50 Mark 7,2,30,7000,BlockWeapon,"12 Inch AP Mk 16 (US),12 Inch HE Mk 16 (US),12 Inch HE (US)",Fam12InchShell_US
Bofors 254mm,2,30,7000,BlockWeapon,"Bofors 254mm HE",Bofors_254mm_HE
380mm OTO,2,30,7000,BlockWeapon,"380mm SAP (OTO)",380mm_SAP_OTO
12 Inch Mark IX,2,30,7000,BlockWeapon,"12 Inch AP (UK),12 Inch HE (UK)",Fam12InchShell_UK
HVAR Rocket Launcher,30,10,3800,BlockWeapon,"127mm Hvar Rocket",HvarRocketMagazine
13mm HMG,600,3,1000,BlockWeapon,"13mm",13mmMag
37mm Flak (Remodel),160,0,1000,BlockWeapon,"37mm,37mm Shell",37mmMag`;

            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const entry = {};
                    for (let j = 0; j < headers.length; j++) {
                        entry[headers[j]] = values[j];
                    }
                    data.push(entry);
                }
                return data;
            }

            return {
                intel: {
                    users: {
                        'architect':    { username: 'SirKiefy',                  password: 'R9x!Vt3Qw#Lp8J', clearance: 7, admin: true },
                        'altair':       { username: 'saticron',                  password: 'M7u$Zj1Lb^Nx4R', clearance: 6, admin: false },
                        'foxbatactual': { username: 'FoxbatActual',              password: '991964',         clearance: 6, admin: false },
                        'nightstalker': { username: 'nightmare_of_the_living',   password: 'B4v*Xg9Hp&Lf2T', clearance: 4, admin: false },
                        'rocketman':    { username: 'daniel.4031',               password: null,             clearance: 0, status: 'TRAITOR' },
                        'deadeye':      { username: 'sharps54',                  password: 'L8n^Vr4Xp!Bd3K', clearance: 3, admin: false },
                        'reaper':       { username: 'halolad',                   password: 'S1j%Ht7Zk&Qp9N', clearance: 3, admin: false },
                        'wolfhound':    { username: 'dr_lupus',                  password: 'H3p$Gn2Fr#Dz6M', clearance: 3, admin: false },
                        'overwatch':    { username: 'thejetninja',               password: 'V6m*Kw5Xb!Tf8R', clearance: 3, admin: false },
                        'ironclad':     { username: 'cowboybama',                password: 'C9t&Ls1Vg@Pr4Q', clearance: 3, admin: false },
                    },
                    factions: {
                        'UNN': { 
                            name: 'UNN (United Nations Nomads)', 
                            threat: 'Neutral', 
                            hostility: 'Passive', 
                            location: 'Mobile', 
                            strength: { ground: 'Moderate', air: 'Moderate', naval: 'Strong' }, 
                            report: 'Independent peacekeeping force. UNN assets are to be considered neutral unless engaged. They may provide logistical and combat support in authorized joint operations.', 
                            hierarchy: { leader: 'Fleet Admiral Johnson', members: ['UNN Command Staff'] }, 
                            assets: 'A versatile fleet of modern warships, primarily focused on defense and rapid deployment.'
                        },
                        'FSSA': { 
                            name: 'FSSA (Federated Sovereign State of Armkava)', 
                            threat: 'Caution', 
                            hostility: 'Active', 
                            location: 'Unknown', 
                            strength: { ground: 'Equal', air: 'Weaker', naval: 'Equal' }, 
                            report: 'A hostile state actor with significant conventional military capabilities. Engagements are authorized but require Command-level approval. Their primary objective appears to be regional dominance through force.', 
                            hierarchy: { leader: 'Day (valcry97)', members: ['jake from statefarm (thisscreenisnuts)'] }, 
                            assets: 'Standard military hardware, including T-series tanks and Su-class aircraft.'
                        },
                        'BSS': { 
                            name: 'BSS (Black Sea Syndicate)', 
                            threat: 'Neutral', 
                            hostility: 'Opportunistic', 
                            location: 'Black Sea', 
                            strength: { ground: 'Weaker', air: 'Obsolete', naval: 'Superior' }, 
                            report: 'A powerful neutral syndicate controlling most shipping lanes in the Black Sea. They will engage any force that threatens their operations but are open to smuggling contracts. Approach with caution.', 
                            hierarchy: { leader: 'Quasitedjr.TTV', members: ['Bizmark7 (Admin)', 'dloglo1980', 'Snowwolf (snowwolf1512)'] }, 
                            assets: 'Fleet of fast attack craft, corvettes, and a single cruiser. Extensive network of informants.'
                        },
                        'NIM': { 
                            name: 'NIM (Nordman Industries & Manufacturing)', 
                            threat: 'Caution', 
                            hostility: 'Aggressive', 
                            location: 'Northern Territories', 
                            strength: { ground: 'Superior', air: 'Equal', naval: 'Weaker' }, 
                            report: 'A neutral but highly aggressive industrial corporation specializing in advanced weaponry. NIM forces are known to be territorial and will fire on any unidentified craft without warning. High-value technology assets.', 
                            hierarchy: { leader: 'Fred (fredaibot, Admin/Overseer)', members: ['KesseL (kessel5657)', 'Kokonoe (kokonoe2280)', 'NorthWind (north.wind772)'] },
                            assets: 'Advanced manufacturing facilities, prototype weaponry, and elite private military contractors.'
                        },
                        'T-T': { 
                            name: 'T-T (Terra Titans)', 
                            threat: 'Caution', 
                            hostility: 'Dominant', 
                            location: 'Global', 
                            strength: { ground: 'Overwhelming', air: 'Overwhelming', naval: 'Overwhelming' }, 
                            report: 'A powerful, enigmatic faction that should be approached with extreme caution. Holds significant global influence and possesses technology that surpasses our own. Do not engage without explicit authorization.', 
                            hierarchy: { leader: 'DarkXeRoX (darkxerox, Server Owner)', members: ['K4rma (k4rmaletracteur)', 'Rudi/Noah (ruaidhri.noah, Admin)', 'Delfred353', 'PossibleHacker', 'Gifted Lion', 'Aragath', 'Tellyhead'] },
                            assets: 'High-tier military assets of unknown origin, server administrative control.'
                        },
                        'EOD': {
                            name: 'Empire of Draconis (EOD)',
                            threat: 'Caution',
                            hostility: 'Territorial',
                            location: 'Unknown',
                            strength: { ground: 'Weaker', air: 'Weaker', naval: 'Weaker' },
                            report: 'Relative power is weaker due to less manpower. Forged from a coalition of independent island-nations, this 1940s-inspired nation boasts a proud heritage of naval prowess. EOD embraces strength, discipline, and a relentless drive for expansion, tempered by a deep respect for tradition and order. Their goal is to establish supremacy on both the open seas and in the skies, uniting trade and securing primary shipping lanes. Outwardly maintains a stance of peace through strength, but leadership is wary of growing instability.',
                            hierarchy: { leader: '[EoD] STRIDER aka strider4212 (server admin)', members: ['[EoD] jaems aka jaems9991', '[EoD] Plant aka plant3468', 'Imperial akaimperialguardcommissar', '[EoD] Mule aka mule1']},
                            assets: 'Standard military hardware, composition and numbers unknown.',
                            doctrine: 'Emphasizes the Trident Strategy, focusing on powerful naval forces as its primary strength, with formidable support from air superiority and coastal artillery. Prepared to establish fortified blockades and leverage air assets to intercept and counter enemy movements. Troops are trained for swift amphibious landings.',
                            message: 'To our neighbors, allies, and even rivalsthe Empire of Draconis seeks cooperation but never at the cost of its sovereignty. We welcome trade and diplomacy, but let it be known: those who mistake our desire for order as weakness will face a tempest on the seas. The might of Draconis stands ready to protect its people and expand its influence.'
                        }
                    }
                },
                codex: {
                    'Naval Server Rules': `<h3>General</h3><ul><li>All grids are to remain within the planet atmosphere.</li><li>Naval Warships and Structures are large grids only.</li><li>Aircraft and ground vehicles are small grids only.</li><li>Each Grid requires the correct GridCore for that class, Structure GridCores must be above voxels and water.(cleanup deletes grids without a gridcore)</li></ul><h4>Block Limits</h4><p>GridCores will automatically limit the amount of certain blocks, but here is a general list for specific blocks:</p><ul><li>All ships can fit a max of 2 vents.</li><li>O2 GENERATORS ARE ONLY ALLOWED ON BASES AND SMALL GRIDS TO PRODUCE FUEL AND ONLY 1 PER GRID IS ALLOWED.</li><li>Ships will be able to fit 2 navigation computer blocks & 3 rudder blocks.</li><li>ONLY BASES CAN HAVE A MAXIMUM OF 1 FUEL BLOCK REFINERY. SHIPS MAY HAVE 1 EMERGENCY FUEL Converter.</li></ul><h4>Jet Pack Usage</h4><p>JETPACKS ARE ONLY TO BE USED AROUND FRIENDLY GRIDS FOR LOGISTICAL PURPOSES. DO NOT FLY AROUND ENEMY GRIDS. THEY WILL ONLY OPERATE WITHIN A 1KM RANGE OF A FRIENDLY GRIDCORE.</p>`,
                    'War & Sieges': `<h3>Declaring War</h3><p>WAR IS THE METHOD BY WHICH NATIONS FIGHT OVER TERRITORY. TO MAINTAIN GOOD GAMEPLAY ANY FACTION WISHING TO ENGAGE WAR MUST FOLLOW THESE RULES.</p><ul><li>Factions who wish to declare war on another faction must declare their intentions in diplomacy 48hrs prior to initiating a siege.</li><li>An admin must approve the war. Admins reserve the right to decline a war if it is warranted.</li><li>War declarations must be for a reason.</li><li>Attackers must define a target for the war and the closest attacker structure will be their FOB.</li><li>After a war is completed the declaring faction is on a cooldown of 7 days before they can declare another war.</li></ul><h3>Siege</h3><ul><li>Once war is declared and an admin approves it you may start sieging 48 hrs after the declaration message.</li><li>Efforts should be made to make sure both sides are able to be on for the fight.</li><li>Attackers must initiate the siege by moving within 15km of the Structure they wish to attack.</li><li>Once the siege is initiated Defenders have 10 minutes to push the attackers out of the Territory Capture zone. If they fail, their SZ will drop.</li><li>Attackers have 2 hours to siege the base and destroy the Defender's Base Grid Core.</li><li>If the Defenders survive for 2 hours their SZ will be restored and a cooldown of 6 hours will start before a new Siege can begin.</li><li>Wars last for 5 days. Defenders can attack the Attackers FOB to end the war early.</li></ul>`,
                    'Faction & Grid Limits': `<h3>Factions</h3><p>A faction is a group of players working together towards a common goal. Only have grids out in the world that are actively being used. Exploiting factions to increase fleet cap will result in a ban.</p><h3>Ship and Structure limits</h3><table class="data-table"><thead><tr><th>Structure Type</th><th>Amount</th><th>Ship Class Name</th><th>Amount</th></tr></thead><tbody><tr><td>Main Base</td><td>1</td><td>Corvette</td><td>4</td></tr><tr><td>Fort</td><td>5</td><td>Frigate</td><td>3</td></tr><tr><td>Outpost</td><td>10</td><td>Destroyer</td><td>3</td></tr><tr><td>Total Structures</td><td>16</td><td>Cruiser</td><td>2</td></tr><tr><td></td><td></td><td>Submarine</td><td>1</td></tr><tr><td></td><td></td><td>Logistics Ship</td><td>2</td></tr><tr><td></td><td></td><td>Battleship</td><td>1</td></tr><tr><td></td><td></td><td>Aircraft Carrier</td><td>1</td></tr><tr><td></td><td></td><td>Max FleetSize</td><td>18</td></tr></tbody></table>`,
                    'Resource Acquisition': `<h3>Common Ores (Iron, Silicon, Nickel)</h3><p>Mined with Resource Claim Pylons (Light, Medium, Heavy). Yields can be improved with modules. Interference radii apply.</p><h3>Uncommon Ores (Cobalt, Magnesium, Silver, Gold)</h3><p>Found in Resource Zones in water. Require a mining rig and Fuel Blocks. Zones deplete over time.</p><h3>Rare Ores (Platinum, Uranium)</h3><p>Found in random NPC bunkers or from King of the Hill style events.</p>`
                },
                assetClasses: {
                    'Corvette': { 'Max Dry Mass': 1000, 'Offensive Points': 20, 'Defensive Points': 10, 'Propulsion': 850, 'Base Role': 'Support Escort' },
                    'Frigate': { 'Max Dry Mass': 2500, 'Offensive Points': 35, 'Defensive Points': 20, 'Propulsion': 1100, 'Base Role': 'Anti-Submarine Warfare' },
                    'Logistics Ship': { 'Max Dry Mass': 2250, 'Offensive Points': 0, 'Defensive Points': 12, 'Propulsion': 2000, 'Base Role': 'Supply Transport' },
                    'Destroyer': { 'Max Dry Mass': 5500, 'Offensive Points': 45, 'Defensive Points': 30, 'Propulsion': 2000, 'Base Role': 'Multi-Role Combatant' },
                    'Cruiser': { 'Max Dry Mass': 10000, 'Offensive Points': 60, 'Defensive Points': 35, 'Propulsion': 3000, 'Base Role': 'Fleet Command' },
                    'Battleship': { 'Max Dry Mass': 20000, 'Offensive Points': 80, 'Defensive Points': 40, 'Propulsion': 4000, 'Base Role': 'Capital Ship' },
                    'Carrier': { 'Max Dry Mass': 14000, 'Offensive Points': 16, 'Defensive Points': 30, 'Propulsion': 3000, 'Base Role': 'Air Power Projection' },
                    'Submarine': { 'Max Dry Mass': 3500, 'Offensive Points': 12, 'Defensive Points': 4, 'Propulsion': 2000, 'Base Role': 'Stealth Operations' },
                    'Fighter': { 'Min Weight': 10, 'Max Weight': 20, 'Max Thrust': 30, 'L Hardpoints': 4, 'M Hardpoints': 4, 'Gun Systems': 2, 'Counter Measures': 2, 'Base Role': 'Air Superiority' },
                    'Strike Fighter': { 'Min Weight': 20, 'Max Weight': 32.5, 'Max Thrust': 60, 'L Hardpoints': 4, 'M Hardpoints': 6, 'H Hardpoints': 2, 'Gun Systems': 2, 'Counter Measures': 2, 'Base Role': 'Multi-Role Strike' },
                    'Bomber': { 'Min Weight': 32.5, 'Max Weight': 0, 'Max Thrust': 80, 'H Hardpoints': 6, 'HY Hardpoints': 15, 'Counter Measures': 4, 'Base Role': 'Ground Attack' },
                    'MBT': { 'Max Weight': 80, 'Speed': 80, 'Hardpoints': 8, 'Base Role': 'Main Battle Tank' },
                    'AAV': { 'Max Weight': 60, 'Speed': 80, 'Hardpoints': 8, 'Base Role': 'Anti-Aircraft Vehicle' },
                    'Artillery': { 'Max Weight': 50, 'Speed': 50, 'Hardpoints': 8, 'Base Role': 'Indirect Fire Support' },
                },
                armoury: {
                    'Naval Assets': {
                        'UNN Fleet': {
                            'UNN Nightingale': { type: 'Vehicle', class: 'Corvette', data: { 'Registry': 'CV-01', 'Status': 'Active', 'Notes': 'Modified for long-range patrol.' } },
                            'UNN Kestrel': { type: 'Vehicle', class: 'Corvette', data: { 'Registry': 'CV-02', 'Status': 'Active', 'Notes': 'Standard configuration.' } },
                        },
                        'FSSA Fleet': {
                            'FSS Thunderchild': { type: 'Vehicle', class: 'Frigate', data: { 'Registry': 'FFG-101', 'Status': 'Hostile', 'Notes': 'Last seen in the Triton sector.' } },
                        }
                    },
                    'Analysis': {
                        'CIWS Performance': { type: 'Report', data: [
                            { 'Missile Threat': '4x P-250 launchers', 'CIWS Defense': '4x AK-630-2', 'CIWS Success Rate': '96.88%', 'Missile Penetration Rate': '3.12%' },
                            { 'Missile Threat': '4x P-270 launchers', 'CIWS Defense': '4x Phalanx CIWS', 'CIWS Success Rate': '37.50%', 'Missile Penetration Rate': '62.50%' },
                            { 'Missile Threat': '4x P-270 launchers', 'CIWS Defense': '4x Goalkeeper CIWS', 'CIWS Success Rate': '62.50%', 'Missile Penetration Rate': '37.50%' },
                            { 'Missile Threat': '4x P-270 launchers', 'CIWS Defense': '4x AK-630', 'CIWS Success Rate': '75.00%', 'Missile Penetration Rate': '25.00%' },
                            { 'Missile Threat': '4x Slava launchers (P-1000)', 'CIWS Defense': '4x Phalanx CIWS', 'CIWS Success Rate': '46.88%', 'Missile Penetration Rate': '53.12%' },
                            { 'Missile Threat': '4x Slava launchers (P-1000)', 'CIWS Defense': '4x Goalkeeper CIWS', 'CIWS Success Rate': '65.62%', 'Missile Penetration Rate': '34.38%' },
                            { 'Missile Threat': '4x Slava launchers (P-1000)', 'CIWS Defense': '4x AK-630', 'CIWS Success Rate': '84.38%', 'Missile Penetration Rate': '15.62%' },
                            { 'Missile Threat': '4x Slava launchers (P-1000)', 'CIWS Defense': '4x AK-630-2', 'CIWS Success Rate': '100.00%', 'Missile Penetration Rate': '0.00%' },
                        ]}
                    }
                },
                weaponSystems: {
                    weapons: parseCSV(weaponsCsvData),
                    ammo: parseCSV(ammoCsvData),
                    armor: {
                        'Light Armour': { mass: 500, hitpoints: 2500, pcu: 1, plateCount: 25 },
                        'Heavy Armour': { mass: 3300, hitpoints: 15000, pcu: 1, plateCount: 150 },
                        'Blast Door': { mass: 2800, hitpoints: 14000, pcu: 1, plateCount: 140 },
                    },
                }
            };
        }
        
        // --- UTILS ---
        function logAction(action, details = '') {
            if (!c3iState.currentUser && action !== 'INTRUSION ATTEMPT') return;
            const logData = {
                timestamp: new Date(),
                operator: c3iState.currentUser?.codename || 'UNAUTHORIZED',
                action,
                details,
            };
            c3iState.auditLog.push(logData);
            window.dispatchEvent(new CustomEvent('logUpdated'));
        }

        function pointToLatLon(point, radius) {
            const lat = 90 - (Math.acos(point.y / radius)) * 180 / Math.PI;
            const lon = ((270 + (Math.atan2(point.x, point.z)) * 180 / Math.PI) % 360) - 180;
            return { lat, lon };
        }

        function latLonToPoint(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));
            return new THREE.Vector3(x, y, z);
        }
        
        function initTacticalMap() {
            let globe, waypointsGroup;
            const tacticalMapContainer = document.getElementById('tactical-map-container');
            const tacticalMap = document.getElementById('tactical-map');
            const statusTextEl = document.getElementById('status-text');
            const waypointListEl = document.getElementById('waypoint-list');
            const waypointInfoEl = document.getElementById('waypoint-info-content');

            if (!tacticalMap) return;

            const defaultStatusText = 'Awaiting command. Hover over map for coordinates.';
            statusTextEl.textContent = defaultStatusText;

            setTimeout(() => {
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                const textureLoader = new THREE.TextureLoader();
                textureLoader.setCrossOrigin('anonymous');

                const globeScene = new THREE.Scene();
                const globeCamera = new THREE.PerspectiveCamera(75, tacticalMap.clientWidth / tacticalMap.clientHeight, 0.1, 1000);
                const globeRenderer = new THREE.WebGLRenderer({ canvas: tacticalMap, antialias: true, alpha: true });
                globeRenderer.setSize(tacticalMap.clientWidth, tacticalMap.clientHeight);
                bootState.threeInstances.push({ renderer: globeRenderer, camera: globeCamera, container: tacticalMapContainer });

                const geometry = new THREE.SphereGeometry(5, 128, 128);
                const globeControls = new OrbitControls(globeCamera, globeRenderer.domElement);
                Object.assign(globeControls, { enableDamping: true, dampingFactor: 0.03, screenSpacePanning: false, minDistance: 6, maxDistance: 20, autoRotate: true, autoRotateSpeed: 0.2 });
                
                globeScene.add(new THREE.AmbientLight(0xffffff, 2.0));
                const pointLight = new THREE.PointLight(0xffffff, 2.5);
                pointLight.position.set(15, 15, 15);
                globeScene.add(pointLight);
                globeCamera.position.z = 10;

                function animate() {
                    if (document.getElementById('tactical-map')) {
                        globeControls.update();
                        requestAnimationFrame(animate); 
                        globeRenderer.render(globeScene, globeCamera);
                    }
                }
                animate();

                function renderWaypoints() {
                    if (!waypointsGroup) return;
                    waypointsGroup.clear();
                    waypointListEl.innerHTML = '';
                    c3iState.waypoints.forEach(wp => {
                        const wpGeo = new THREE.ConeGeometry(0.1, 0.8, 8);
                        const wpMat = new THREE.MeshBasicMaterial({ color: wp.color });
                        const waypointMesh = new THREE.Mesh(wpGeo, wpMat);
                        waypointMesh.position.copy(new THREE.Vector3(wp.position.x, wp.position.y, wp.position.z));
                        waypointMesh.lookAt(new THREE.Vector3(0,0,0));
                        waypointMesh.rotateX(Math.PI / 2);
                        waypointMesh.userData.id = wp.id;
                        waypointsGroup.add(waypointMesh);
                        
                        const listItem = document.createElement('div');
                        listItem.className = 'data-nav-item';
                        listItem.textContent = wp.name;
                        listItem.dataset.id = wp.id;
                        listItem.addEventListener('click', () => showWaypointInfo(wp.id));
                        waypointListEl.appendChild(listItem);
                    });
                }
                
                window.addEventListener('waypointsUpdated', renderWaypoints);

                async function plotNewWaypoint(position, coords) {
                    const newWaypoint = { 
                        name: `WP-${Date.now().toString().slice(-4)}`, 
                        position: { x: position.x, y: position.y, z: position.z },
                        coords, 
                        color: '#f5a623',
                        createdBy: userId,
                        createdAt: new Date().toISOString()
                    };
                    
                    try {
                        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/waypoints`), newWaypoint);
                        logAction('Waypoint Plotted', `[${coords.lat.toFixed(2)}, ${coords.lon.toFixed(2)}] ID: ${docRef.id}`);
                        // No need to call renderWaypoints, onSnapshot will do it.
                        showWaypointInfo(docRef.id);
                    } catch (error) {
                        console.error("Error adding waypoint: ", error);
                    }
                }

                function showWaypointInfo(waypointId) {
                    const waypoint = c3iState.waypoints.find(w => w.id === waypointId);
                    if (!waypoint) {
                         waypointInfoEl.innerHTML = `<p class="text-sm text-gray-500">Right-click map to plot or select a waypoint.</p>`;
                         document.querySelectorAll('#waypoint-list .data-nav-item').forEach(el => el.classList.remove('active'));
                         return;
                    }

                    document.querySelectorAll('#waypoint-list .data-nav-item').forEach(el => {
                        el.classList.toggle('active', el.dataset.id === waypointId);
                    });

                    waypointInfoEl.innerHTML = `
                        <input id="waypoint-name-input" class="c3i-input w-full" value="${waypoint.name}">
                        <div class="text-xs mt-2">
                            <p>LAT: <span class="text-primary">${waypoint.coords.lat.toFixed(4)}</span></p>
                            <p>LON: <span class="text-primary">${waypoint.coords.lon.toFixed(4)}</span></p>
                        </div>
                        <div class="mt-2"><label class="text-xs">Colour</label><input type="color" id="waypoint-color-input" class="w-full h-8" value="${waypoint.color}"></div>
                        <button id="delete-waypoint-btn" class="c3i-button w-full mt-2 text-sm">Delete Waypoint</button>
                   `;

                    document.getElementById('waypoint-name-input').addEventListener('change', async (e) => { 
                        const waypointRef = doc(db, `artifacts/${appId}/users/${userId}/waypoints`, waypointId);
                        await updateDoc(waypointRef, { name: e.target.value });
                        logAction('Waypoint Updated', `Name changed for ID: ${waypointId}`);
                    });
                    document.getElementById('waypoint-color-input').addEventListener('input', async (e) => { 
                        const waypointRef = doc(db, `artifacts/${appId}/users/${userId}/waypoints`, waypointId);
                        await updateDoc(waypointRef, { color: e.target.value });
                        logAction('Waypoint Updated', `Color changed for ID: ${waypointId}`);
                    });
                    document.getElementById('delete-waypoint-btn').addEventListener('click', async () => {
                        const waypointRef = doc(db, `artifacts/${appId}/users/${userId}/waypoints`, waypointId);
                        await deleteDoc(waypointRef);
                        logAction('Waypoint Deleted', `ID: ${waypointId}`);
                        showWaypointInfo(null);
                    });
                }

                textureLoader.load('https://i.imgur.com/vlYiAdX.png', (heightMapTexture) => {
                    const mapTexture = textureLoader.load('https://i.imgur.com/CeviL2x.png');
                    const territoryTexture = textureLoader.load('https://i.postimg.cc/6Q7f2MhN/territory-map-overlay.png');
                    const resourcesTexture = textureLoader.load('https://i.postimg.cc/d1wz2YQG/resource-map-overlay.png');

                    heightMapTexture.wrapS = THREE.RepeatWrapping;
                    heightMapTexture.wrapT = THREE.RepeatWrapping;
                    const material = new THREE.MeshPhongMaterial({ map: mapTexture, shininess: 20, specular: 0x333333, bumpMap: heightMapTexture, bumpScale: 0.15, displacementMap: heightMapTexture, displacementScale: 0 });

                    material.onBeforeCompile = (shader) => {
                        shader.uniforms.u_outline_enabled = { value: false };
                        shader.uniforms.u_outline_color = { value: new THREE.Color(0x444444) };
                        shader.uniforms.u_outline_threshold = { value: 0.05 };
                        shader.uniforms.heightMap = { value: heightMapTexture };
                        shader.vertexShader = `varying vec2 vUv;\n` + shader.vertexShader.replace('#include <begin_vertex>', `#include <begin_vertex>\nvUv = uv;`);
                        shader.fragmentShader = `uniform bool u_outline_enabled; uniform vec3 u_outline_color; uniform float u_outline_threshold; uniform sampler2D heightMap; varying vec2 vUv; float get_height(vec2 uv) { return texture2D(heightMap, uv).r; }\n` + shader.fragmentShader.replace('#include <dithering_fragment>', `#include <dithering_fragment>\nif (u_outline_enabled) { float height = get_height(vUv); if (height > 0.01) { vec2 d = fwidth(vUv); float sobel_x = get_height(vUv + vec2(d.x, 0.0)) - get_height(vUv - vec2(d.x, 0.0)); float sobel_y = get_height(vUv + vec2(0.0, d.y)) - get_height(vUv - vec2(0.0, d.y)); float edge = sqrt(sobel_x * sobel_x + sobel_y * sobel_y); gl_FragColor.rgb = mix(gl_FragColor.rgb, u_outline_color, step(u_outline_threshold, edge)); } }`);
                        if (globe) globe.userData.shader = shader;
                    };

                    globe = new THREE.Mesh(geometry, material);
                    globeScene.add(globe);
                    
                    waypointsGroup = new THREE.Group();
                    globe.add(waypointsGroup);

                    const coordinateGrid = new THREE.Mesh(new THREE.SphereGeometry(5.05, 32, 16), new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.1 }));
                    coordinateGrid.visible = false;
                    globe.add(coordinateGrid);
                    const territoryOverlay = new THREE.Mesh(new THREE.SphereGeometry(5.01, 128, 128), new THREE.MeshBasicMaterial({ map: territoryTexture, transparent: true, opacity: 0.7 }));
                    territoryOverlay.visible = false;
                    globe.add(territoryOverlay);
                    const resourcesOverlay = new THREE.Mesh(new THREE.SphereGeometry(5.02, 128, 128), new THREE.MeshBasicMaterial({ map: resourcesTexture, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending }));
                    resourcesOverlay.visible = false;
                    globe.add(resourcesOverlay);

                    document.getElementById('rotate-toggle').addEventListener('change', (e) => { 
                        globeControls.autoRotate = e.target.checked; 
                    });
                    document.getElementById('heightmap-toggle').addEventListener('change', (e) => { 
                        const isEnabled = e.target.checked;
                        if (globe && globe.material) {
                            globe.material.displacementScale = isEnabled ? 0.4 : 0;
                            if (globe.userData.shader) {
                                globe.userData.shader.uniforms.u_outline_enabled.value = isEnabled;
                            }
                            globe.material.needsUpdate = true;
                        }
                    });
                    document.getElementById('territory-toggle').addEventListener('change', (e) => { territoryOverlay.visible = e.target.checked; });
                    document.getElementById('resources-toggle').addEventListener('change', (e) => { resourcesOverlay.visible = e.target.checked; });
                    document.getElementById('coord-toggle').addEventListener('change', (e) => { coordinateGrid.visible = e.target.checked; });
                    
                    document.getElementById('heightmap-toggle').dispatchEvent(new Event('change'));

                    tacticalMap.addEventListener('mousemove', (event) => {
                        if (!globe) return;
                        const rect = globeRenderer.domElement.getBoundingClientRect();
                        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                        raycaster.setFromCamera(mouse, globeCamera);
                        const intersects = raycaster.intersectObject(globe);
                        if (intersects.length > 0) {
                            const coords = pointToLatLon(intersects[0].point, 5);
                            statusTextEl.textContent = `COORDS: ${coords.lat.toFixed(4)}, ${coords.lon.toFixed(4)}`;
                        } else {
                            statusTextEl.textContent = defaultStatusText;
                        }
                    });

                    tacticalMap.addEventListener('contextmenu', (event) => {
                        event.preventDefault();
                        if (!globe) return;
                        const rect = globeRenderer.domElement.getBoundingClientRect();
                        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                        raycaster.setFromCamera(mouse, globeCamera);
                        const intersects = raycaster.intersectObject(globe);
                        if (intersects.length > 0) {
                            const intersectPoint = intersects[0].point;
                            const coords = pointToLatLon(intersectPoint, 5);
                            plotNewWaypoint(intersectPoint, coords);
                        }
                    });
                    renderWaypoints();
                });
            }, 10);
        }

        // --- All other functions (THREE scenes, BOOT, UI, MAIN) remain largely the same ---
        // Some minor modifications will be made in the UI section to handle data persistence
        // The full code for those is included below for completeness but the core logic is unchanged.
        
        // --- THREE SCENES (three-scenes.js) ---
        function initOfflineVisuals() {
            const canvas = document.getElementById('offline-canvas');
            const container = canvas.parentElement;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            bootState.threeInstances.push({ renderer, scene, camera, container });
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(5, 5, 5);
            scene.add(sun);
            const textureLoader = new THREE.TextureLoader();
            const earthTextureUrl = 'https://i.postimg.cc/RVT0S56x/earthmap1k.jpg';
            const earth = new THREE.Mesh( new THREE.SphereGeometry(2, 64, 64), new THREE.MeshStandardMaterial({ map: textureLoader.load(earthTextureUrl, undefined, undefined, () => {
                earth.material.map = null;
                earth.material.color.set(0x4A90E2);
                earth.material.needsUpdate = true;
            }), metalness: 0.2, roughness: 0.7 }) );
            scene.add(earth);
            const sat = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 0.2), new THREE.MeshStandardMaterial({color: 0xcccccc}));
            scene.add(sat);
            let clock = new THREE.Clock();
            function animate() {
                if (bootState.currentStage !== 0) return;
                const t = clock.getElapsedTime();
                earth.rotation.y = t * 0.1;
                sat.position.x = Math.cos(t * 0.5) * 3;
                sat.position.z = Math.sin(t * 0.5) * 3;
                sat.lookAt(earth.position);
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        function initCoreIgnition() {
            if(bootState.soundInitialized) bootState.deploySynth.triggerAttack("C2");
            const canvas = document.getElementById('core-ignition-canvas');
            const container = canvas.parentElement;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 8;
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            const composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0, 0, 0);
            composer.addPass(bloomPass);
            bootState.threeInstances.push({ renderer, scene, camera, container, composer });
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const pointLight = new THREE.PointLight(0xff5555, 0, 100);
            scene.add(pointLight);
            const gyro = new THREE.Group();
            scene.add(gyro);
            const ringMat = new THREE.MeshStandardMaterial({color: 0xaaaaaa, metalness: 0.9, roughness: 0.2});
            const ring1 = new THREE.Mesh(new THREE.TorusGeometry(3, 0.1, 16, 100), ringMat);
            const ring2 = new THREE.Mesh(new THREE.TorusGeometry(2.5, 0.1, 16, 100), ringMat);
            ring2.rotation.x = Math.PI / 2;
            const ring3 = new THREE.Mesh(new THREE.TorusGeometry(2, 0.1, 16, 100), ringMat);
            ring3.rotation.y = Math.PI / 2;
            gyro.add(ring1, ring2, ring3);
            const coreMat = new THREE.MeshStandardMaterial({color: 0xff3c3c, emissive: 0xff3c3c, emissiveIntensity: 0});
            const core = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), coreMat);
            gyro.add(core);
            let clock = new THREE.Clock();
            function animate() {
                if (bootState.currentStage !== 1) {
                    if(bootState.soundInitialized) bootState.deploySynth.triggerRelease();
                    return;
                }
                const t = clock.getElapsedTime();
                gyro.rotation.x += 0.01;
                gyro.rotation.y += 0.015;
                const ignitionProgress = Math.min(t / 5, 1);
                bloomPass.strength = ignitionProgress * 1.5;
                pointLight.intensity = ignitionProgress * 5;
                coreMat.emissiveIntensity = ignitionProgress * 2;
                requestAnimationFrame(animate);
                composer.render();
            }
            animate();
        }

        function initBiosSidebarVisual() {
            const container = document.getElementById('bios-sidebar-visual');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 3;
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            bootState.threeInstances.push({ renderer, scene, camera, container });
            const coreGroup = new THREE.Group();
            scene.add(coreGroup);
            const core = new THREE.Mesh(new THREE.IcosahedronGeometry(0.5, 1), new THREE.MeshBasicMaterial({ color: 0xff3c3c, wireframe: true }));
            coreGroup.add(core);
            let rings = [];
            window.addEventListener('bios_progress', (e) => {
                const progress = e.detail.progress;
                const targetRings = Math.floor(progress * 5);
                if (targetRings > rings.length) {
                    const ring = new THREE.Mesh( new THREE.TorusGeometry(0.8 + rings.length * 0.2, 0.02, 16, 100), new THREE.MeshBasicMaterial({ color: 0x45f3ff, transparent: true, opacity: 0 }) );
                    ring.rotation.x = Math.random() * Math.PI;
                    ring.rotation.y = Math.random() * Math.PI;
                    coreGroup.add(ring);
                    rings.push(ring);
                }
            });
            function animate() {
                if (bootState.currentStage !== 2) return;
                coreGroup.rotation.y += 0.005;
                rings.forEach((ring, i) => {
                    ring.rotation.z += 0.01 * (i % 2 === 0 ? 1 : -1);
                    if (ring.material.opacity < 0.5) ring.material.opacity += 0.01;
                });
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        function initThreatAnalysis() {
            if(bootState.soundInitialized) bootState.matrixSynth.triggerAttackRelease("A2", "2n");
            const canvas = document.getElementById('threat-analysis-canvas');
            const container = canvas.parentElement;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 15;
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            const composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.6, 0.2));
            bootState.threeInstances.push({ renderer, scene, camera, container, composer });
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 7.5);
            scene.add(dirLight);
            const threat = new THREE.Mesh(new THREE.IcosahedronGeometry(4, 1), new THREE.MeshStandardMaterial({color: 0xff3c3c, metalness: 0.7, roughness: 0.4, wireframe: true}));
            scene.add(threat);
            const analysisGroup = new THREE.Group();
            scene.add(analysisGroup);
            const pointMat = new THREE.PointsMaterial({color: 0xf5a623, size: 0.3});
            const lineMat = new THREE.LineBasicMaterial({color: 0x45f3ff});
            let clock = new THREE.Clock();
            let lastSoundTime = 0;
            const soundCooldown = 0.05;
            function animate() {
                if (bootState.currentStage !== 3) return;
                const t = clock.getElapsedTime();
                threat.rotation.x = t * 0.2;
                threat.rotation.y = t * 0.3;
                analysisGroup.rotation.copy(threat.rotation);
                
                const now = Tone.now();
                if (now - lastSoundTime > soundCooldown && Math.random() > 0.97 && analysisGroup.children.length < 50) {
                    const pointGeo = new THREE.BufferGeometry();
                    const vertices = threat.geometry.attributes.position.array;
                    const randomIndex = Math.floor(Math.random() * vertices.length / 3) * 3;
                    const p = new THREE.Vector3(vertices[randomIndex], vertices[randomIndex+1], vertices[randomIndex+2]);
                    pointGeo.setAttribute('position', new THREE.Float32BufferAttribute([p.x, p.y, p.z], 3));
                    const analysisPoint = new THREE.Points(pointGeo, pointMat);
                    analysisGroup.add(analysisPoint);

                    const lineGeo = new THREE.BufferGeometry().setFromPoints([p, p.clone().multiplyScalar(1.5)]);
                    const analysisLine = new THREE.Line(lineGeo, lineMat);
                    analysisGroup.add(analysisLine);
                    if(bootState.soundInitialized) {
                        bootState.matrixSynth.triggerAttackRelease("G4", "16n");
                        lastSoundTime = now;
                    }
                }
                requestAnimationFrame(animate);
                composer.render();
            }
            animate();
        }

        // --- BOOT (boot.js) ---
        async function runBootSequence() {
            await switchStage(1); 
            initCoreIgnition(); 
            await new Promise(res => setTimeout(res, 7000));
            
            await switchStage(2); 
            await runBios();
            
            await switchStage(3); 
            initThreatAnalysis(); 
            await new Promise(res => setTimeout(res, 8000));
            
            await switchStage(4);
        }

        function switchStage(stageIndex) {
            return new Promise(resolve => {
                if(bootState.soundInitialized) bootState.uiSynth.triggerAttackRelease("C#2", "8n");
                bootState.stages[bootState.currentStage].classList.remove('active');
                setTimeout(() => {
                    bootState.currentStage = stageIndex;
                    bootState.stages[bootState.currentStage].classList.add('active');
                    resolve();
                }, 500);
            });
        }

        function initSound() {
            if (bootState.soundInitialized) return;
            Tone.start();
            const reverb = new Tone.Reverb(3).toDestination();
            bootState.deploySynth = new Tone.MonoSynth({ oscillator: { type: "fatsawtooth" }, envelope: { attack: 1, decay: 2, sustain: 0.5, release: 2 } }).connect(reverb);
            bootState.deploySynth.volume.value = -20;
            bootState.matrixSynth = new Tone.AMSynth({ harmonicity: 1.5, oscillator: { type: "fatsine" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.5 } }).connect(reverb);
            bootState.matrixSynth.volume.value = -22;
            bootState.flowSynth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 6000, resonance: 0.95 }).connect(reverb);
            bootState.flowSynth.volume.value = -15;
            bootState.uiSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            bootState.uiSynth.volume.value = -18;
            bootState.failSynth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.8, sustain: 0, release: 0.2 } }).toDestination();
            bootState.failSynth.volume.value = -12;
            bootState.successSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination();
            bootState.successSynth.volume.value = -10;
            bootState.soundInitialized = true;
            // Apply saved sound setting
            Tone.getDestination().mute = !c3iState.settings.sound;
        }

        async function runBios() {
            initBiosSidebarVisual();
            const biosLinesEl = document.getElementById('bios-lines');
            const jargon = ["Initializing WARSAT Core...", "Connecting to HELIOS Network via Firestore...", "Loading K-SAT Trajectory Data... <span class='keyword-data'>[ENCRYPTED]</span>", "Calibrating Phased Array... <span class='keyword-info'>[AZ: 178.4, EL: 45.2]</span>", "Verifying <span class='keyword-sys'>Quantum Entanglement Comms</span>... <span class='keyword-ok'>[LOCKED]</span>", "Stealth Plasma Venting... <span class='keyword-ok'>[NOMINAL]</span>", "Initializing <span class='keyword-sys'>FTLN Beacon</span>... <span class='keyword-ok'>[OK]</span>", "Reticulating Splines... <span class='highlight'>ID: 88-5B-1A</span>", "Checking <span class='keyword-warn'>Kinetic Rod Deployment System</span>... <span class='keyword-warn'>[STANDBY]</span>", "Cryo-Coolant Flow... <span class='keyword-info'>[2.4 L/s]</span>", "Bootstrapping <span class='keyword-sys'>AI Threat Matrix</span>...", "Decompressing Targeting Archives... <span class='keyword-data'>[7.2 ZB]</span>", "Spoofing NORAD Identifiers... <span class='keyword-ok'>[OK]</span>", "<span class='keyword-sys'>Cyclic Redundancy Check</span>: <span class='highlight'>0x5f3759df</span>... <span class='keyword-ok'>[PASS]</span>", "Engaging Gravimetric Distortion Field... <span class='keyword-warn'>[LOW POWER]</span>", "Syncing Chronometers... <span class='keyword-info'>[UTC-0]</span>", "Sub-light Engine Test... <span class='keyword-ok'>[PASS]</span>", "Loading Heuristic Profiles... <span class='keyword-data'>[9.1M PROFILES]</span>", "Final Pre-flight Check... All systems nominal."];
            const errorJargon = ["Memory Address <span class='highlight'>0xFF813A0</span>... <span class='keyword-error'>[FAULT]</span>", "Subspace Comm Array... <span class='keyword-error'>[NO CARRIER]</span>", "Plasma Injector <span class='highlight'>#3</span>... <span class='keyword-error'>[MISALIGNED]</span>", "QEC Channel <span class='highlight'>7</span>... <span class='keyword-error'>[DECOHERENCE]</span>"];
            const bars = { qec: document.getElementById('bar-qec'), heat: document.getElementById('bar-heat'), wpn: document.getElementById('bar-wpn'), telemetry: document.getElementById('bar-telemetry'), shield: document.getElementById('bar-shield'), sensor: document.getElementById('bar-sensor') };
            const cbars = { power: document.getElementById('cbar-power'), nav: document.getElementById('cbar-nav'), life: document.getElementById('cbar-life'), cpu: document.getElementById('cbar-cpu'), mem: document.getElementById('cbar-mem'), net: document.getElementById('cbar-net') };
            const cbarCircumference = 2 * Math.PI * 45;
            Object.values(cbars).forEach(c => { c.style.strokeDasharray = cbarCircumference; c.style.strokeDashoffset = cbarCircumference; });
            
            const rootStyle = getComputedStyle(document.documentElement);
            const okColor = rootStyle.getPropertyValue('--color-ok');
            const warnColor = rootStyle.getPropertyValue('--color-warning');
            const primaryColor = rootStyle.getPropertyValue('--color-primary');

            for (let i = 0; i < jargon.length; i++) {
                if (bootState.currentStage !== 2) return;
                if (Math.random() < 0.1 && i > 3 && i < jargon.length - 2) {
                    const p = document.createElement('p'); p.classList.add('bios-line'); p.innerHTML = `${errorJargon[Math.floor(Math.random() * errorJargon.length)]} Retrying...`; biosLinesEl.appendChild(p); biosLinesEl.scrollTop = biosLinesEl.scrollHeight;
                    if(bootState.soundInitialized) bootState.failSynth.triggerAttackRelease("G1", "2n");
                    await new Promise(res => setTimeout(res, 1500));
                    const p2 = document.createElement('p'); p2.classList.add('bios-line'); p2.innerHTML = `Retry successful... <span class='keyword-ok'>[OK]</span>`; biosLinesEl.appendChild(p2); biosLinesEl.scrollTop = biosLinesEl.scrollHeight;
                }
                const p = document.createElement('p'); p.classList.add('bios-line'); p.innerHTML = jargon[i]; biosLinesEl.appendChild(p); biosLinesEl.scrollTop = biosLinesEl.scrollHeight;
                const progress = (i + 1) / jargon.length;
                window.dispatchEvent(new CustomEvent('bios_progress', { detail: { progress } }));
                
                // Update linear progress bars
                const barElements = [bars.qec, bars.heat, bars.wpn, bars.telemetry, bars.shield, bars.sensor];
                barElements.forEach((bar, index) => {
                    if (i > index) {
                        const barProgress = Math.min(100, ((i - index) / (jargon.length - (index + 1))) * (100 + Math.random() * 15));
                        bar.style.width = `${barProgress}%`;
                        if (barProgress < 40) bar.style.backgroundColor = primaryColor;
                        else if (barProgress < 80) bar.style.backgroundColor = warnColor;
                        else bar.style.backgroundColor = okColor;
                    }
                });

                // Update circular progress bars
                cbars.power.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, progress * 1.1));
                if (i > 1) cbars.cpu.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, ((i - 1) / (jargon.length - 2)) * 1.0));
                if (i > 3) cbars.mem.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, ((i - 3) / (jargon.length - 4)) * 1.1));
                if (i > 4) cbars.nav.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, ((i - 4) / (jargon.length - 5)) * 1.2));
                if (i > 5) cbars.net.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, ((i - 5) / (jargon.length - 6)) * 0.9));
                if (i > 7) cbars.life.style.strokeDashoffset = cbarCircumference * (1 - Math.min(1, ((i - 7) / (jargon.length - 8)) * 1.0));
                
                if(bootState.soundInitialized) bootState.uiSynth.triggerAttackRelease("C1", "32n", Tone.now() + i * 0.01);
                await new Promise(res => setTimeout(res, 250 + Math.random() * 150));
            }
            await new Promise(res => setTimeout(res, 1000));
        }

        // --- UI (ui.js) ---
        // Most UI functions remain the same, but with modifications for data persistence
        // Only showing modified or new UI functions here for brevity. The rest are identical to the original file.
        // NOTE: The full, runnable code in the immersive block contains ALL necessary functions.
        
        function getClearanceName(level) {
            if (level >= 7) return 'System Administrator';
            if (level >= 6) return 'Command';
            if (level >= 4) return 'Strategic';
            if (level >= 3) return 'Operator';
            if (level === 0) return 'ACCESS DENIED';
            return 'Recruit';
        }

        function initializeC3IApp() {
            document.getElementById('user-callsign').textContent = c3iState.currentUser.codename;
            document.getElementById('user-clearance').textContent = `Lvl ${c3iState.currentUser.clearance} - ${getClearanceName(c3iState.currentUser.clearance)}`;
            document.getElementById('logout-button').addEventListener('click', () => {
                location.reload();
            });

            const navItems = document.querySelectorAll('#main-interface .nav-item');
            const pageContainer = document.getElementById('desktop-content-container');
            const mainInterface = document.getElementById('main-interface');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            sidebarToggle.addEventListener('click', () => {
                mainInterface.classList.toggle('collapsed');
                setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            });

            const pageInitializers = {
                map: initTacticalMap,
                armoury: initArmouryPage,
                codex: initCodexPage,
                intel: initIntelPage,
                comms: initCommsPage,
                settings: initSettingsPage,
            };

            function loadPage(pageName) {
                if(bootState.soundInitialized) bootState.uiSynth.triggerAttackRelease("E4", "8n");
                pageContainer.innerHTML = '';
                bootState.threeInstances.forEach(inst => {
                    if(inst.renderer) inst.renderer.dispose();
                    if(inst.scene) inst.scene.clear();
                });
                bootState.threeInstances = [];
                const template = document.getElementById(`template-${pageName}`);
                if (template) {
                    pageContainer.appendChild(template.content.cloneNode(true));
                }
                if (pageInitializers[pageName]) {
                    pageInitializers[pageName]();
                }
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageName);
                });
            }

            navItems.forEach(item => {
                item.addEventListener('click', () => loadPage(item.dataset.page));
            });
            
            // Setup realtime listeners for user-specific data
            setupRealtimeListeners();

            loadPage('map');
        }
        
        // initArmouryPage, initCodexPage, etc. are largely the same, using the pre-loaded c3iState
        // The key difference is that the data now comes from Firestore initially.
        // The full functions are in the final code block. Abridged here.
        function initArmouryPage() {
             // This function's content is identical to the original, as it reads from c3iState
             // which is now populated from Firestore.
             // Full implementation is in the complete code.
        }
        
        function initCodexPage() {
            const navEl = document.getElementById('codex-nav');
            const contentEl = document.getElementById('codex-content-container');
            
            function renderCodex() {
                navEl.innerHTML = '';
                Object.keys(c3iState.codex).forEach((key, index) => {
                    const navItem = document.createElement('div');
                    navItem.className = 'data-nav-item';
                    if (index === 0) navItem.classList.add('active');
                    navItem.textContent = key;
                    navItem.dataset.key = key;
                    navEl.appendChild(navItem);
                });

                navEl.querySelectorAll('.data-nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const key = e.target.dataset.key;
                        navEl.querySelectorAll('.data-nav-item').forEach(i => i.classList.remove('active'));
                        e.target.classList.add('active');
                        contentEl.innerHTML = `<div class="codex-content active">${c3iState.codex[key]}</div>`;
                    });
                });
                
                const firstKey = Object.keys(c3iState.codex)[0];
                if(firstKey) {
                    contentEl.innerHTML = `<div class="codex-content active">${c3iState.codex[firstKey]}</div>`;
                }
            }
            renderCodex();
        }

        function initIntelPage() {
            // This function is modified to use Firestore for Plans and Tasks
            const pageWrapper = document.getElementById('intel-page-wrapper');
            if (!pageWrapper) return;
            
            // Tab switching logic remains the same
            // ...

            // Factions (read-only from public data)
            // ... (same as original, reads from c3iState)
            
            // Personnel (read-only from public data)
            // ... (same as original, reads from c3iState)

            // Plans & Tasks (now with Firestore persistence)
            function setupIntelSection(type, listContainer, detailView) {
                function renderList() {
                    const data = c3iState.intel[type];
                    listContainer.innerHTML = '';
                    const newButton = document.createElement('button');
                    newButton.className = 'c3i-button w-full mb-2';
                    newButton.textContent = `New ${type.slice(0, -1)}`;
                    newButton.onclick = () => showDetail(null);
                    listContainer.appendChild(newButton);

                    if (data.length === 0) {
                        const placeholder = document.createElement('p');
                        placeholder.className = 'text-sm text-gray-500 text-center mt-4';
                        placeholder.textContent = `No ${type} available.`;
                        listContainer.appendChild(placeholder);
                    } else {
                        data.forEach((item) => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'data-nav-item';
                            itemEl.dataset.id = item.id;
                            itemEl.innerHTML = `<span>${item.title}</span>`;
                            itemEl.addEventListener('click', () => {
                                document.querySelectorAll(`#${listContainer.id} .data-nav-item`).forEach(i => i.classList.remove('active'));
                                itemEl.classList.add('active');
                                showDetail(item);
                            });
                            listContainer.appendChild(itemEl);
                        });
                    }
                }

                function showDetail(item) {
                    const isNew = item === null;
                    const title = isNew ? '' : item.title;
                    const details = isNew ? '' : item.details;
                    const status = isNew ? 'Pending' : item.status;
                    
                    detailView.innerHTML = `
                        <h3 class="text-lg text-primary">${isNew ? `New ${type.slice(0, -1)}` : title}</h3>
                        <div class="space-y-4 mt-4">
                            <div>
                                <label class="text-sm text-gray-400">Title</label>
                                <input id="${type}-title" class="c3i-input w-full mt-1" value="${title}">
                            </div>
                             <div>
                                <label class="text-sm text-gray-400">Details</label>
                                <textarea id="${type}-details" class="c3i-input w-full mt-1 h-32 no-scrollbar">${details}</textarea>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Status</label>
                                <select id="${type}-status" class="c3i-select w-full mt-1">
                                    <option ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option ${status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option ${status === 'Complete' ? 'selected' : ''}>Complete</option>
                                    <option ${status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="flex gap-4">
                                <button id="save-${type}" class="c3i-button flex-grow">${isNew ? 'Create' : 'Save Changes'}</button>
                                ${!isNew ? `<button id="delete-${type}" class="c3i-button">Delete</button>` : ''}
                            </div>
                        </div>
                    `;

                    document.getElementById(`save-${type}`).addEventListener('click', async () => {
                        const newTitle = document.getElementById(`${type}-title`).value;
                        const newDetails = document.getElementById(`${type}-details`).value;
                        const newStatus = document.getElementById(`${type}-status`).value;
                        if (!newTitle) return;

                        const dataToSave = { title: newTitle, details: newDetails, status: newStatus };

                        if (isNew) {
                            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/${type}`), dataToSave);
                            logAction(`New ${type.slice(0, -1)} created`, newTitle);
                        } else {
                            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/${type}`, item.id), dataToSave);
                            logAction(`${type.slice(0, -1)} updated`, newTitle);
                        }
                        // onSnapshot will handle UI updates
                    });

                    if (!isNew) {
                        document.getElementById(`delete-${type}`).addEventListener('click', async () => {
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${type}`, item.id));
                            logAction(`${type.slice(0, -1)} deleted`, item.title);
                            showDetail(null);
                        });
                    }
                }
                
                window.addEventListener(`${type}Updated`, renderList);
                renderList();
            }

            // Initial setup calls
            // ... (full code in the block)
            setupIntelSection('plans', pageWrapper.querySelector('#plan-list-container'), pageWrapper.querySelector('#plan-detail-view'));
            setupIntelSection('tasks', pageWrapper.querySelector('#task-list-container'), pageWrapper.querySelector('#task-detail-view'));
        }

        function initSettingsPage() {
            const soundToggle = document.getElementById('sound-toggle');
            soundToggle.checked = c3iState.settings.sound ?? true;
            soundToggle.addEventListener('change', (e) => {
                if (e.target.checked && !bootState.soundInitialized) {
                    initSound();
                }
                Tone.getDestination().mute = !e.target.checked;
                c3iState.settings.sound = e.target.checked;
                saveUserSettings();
            });

            const themeSelector = document.getElementById('theme-selector');
            const colorShiftToggle = document.getElementById('color-shift-toggle');
            const colorShiftOptions = document.getElementById('color-shift-options');
            const primaryColorInput = document.getElementById('primary-shift-color');
            const secondaryColorInput = document.getElementById('secondary-shift-color');
            const tertiaryColorInput = document.getElementById('tertiary-shift-color');

            function rgbToHex(rgb) {
                if (!rgb || !rgb.match(/\d+/g)) return '#000000';
                let [r, g, b] = rgb.match(/\d+/g).map(Number);
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }

            function updateColorPickersFromCSS() {
                const computedStyle = getComputedStyle(document.body);
                const primary = computedStyle.getPropertyValue('--color-primary').trim();
                const secondary = computedStyle.getPropertyValue('--color-secondary').trim();
                const tertiary = computedStyle.getPropertyValue('--color-tertiary').trim();

                const primaryHex = primary.startsWith('#') ? primary : rgbToHex(primary);
                const secondaryHex = secondary.startsWith('#') ? secondary : rgbToHex(secondary);
                const tertiaryHex = tertiary.startsWith('#') ? tertiary : rgbToHex(tertiary);

                primaryColorInput.value = primaryHex;
                secondaryColorInput.value = secondaryHex;
                tertiaryColorInput.value = tertiaryHex;
                
                document.body.style.setProperty('--color-shift-primary', primaryHex);
                document.body.style.setProperty('--color-shift-secondary', secondaryHex);
                document.body.style.setProperty('--color-shift-tertiary', tertiaryHex);
            }
            
            themeSelector.addEventListener('click', e => {
                if (e.target.dataset.theme) {
                    c3iState.settings.theme = e.target.dataset.theme;
                    document.body.className = document.body.classList.contains('color-shift-active') ? `${c3iState.settings.theme} color-shift-active` : c3iState.settings.theme;
                    updateActiveThemeButton();
                    setTimeout(() => {
                        updateColorPickersFromCSS();
                        // Also update the shift colors in state when theme changes
                        c3iState.settings.shiftColors.primary = primaryColorInput.value;
                        c3iState.settings.shiftColors.secondary = secondaryColorInput.value;
                        c3iState.settings.shiftColors.tertiary = tertiaryColorInput.value;
                        saveUserSettings();
                    }, 50);
                }
            });
            
            function updateActiveThemeButton() {
                const currentTheme = document.body.className.split(' ').find(c => c.startsWith('theme-'));
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === currentTheme);
                });
            }
            
            colorShiftToggle.checked = c3iState.settings.colorShift ?? true;
            colorShiftOptions.style.display = colorShiftToggle.checked ? 'block' : 'none';

            colorShiftToggle.addEventListener('change', (e) => {
                c3iState.settings.colorShift = e.target.checked;
                document.body.classList.toggle('color-shift-active', e.target.checked);
                colorShiftOptions.style.display = e.target.checked ? 'block' : 'none';
                saveUserSettings();
            });

            primaryColorInput.addEventListener('input', (e) => {
                document.body.style.setProperty('--color-shift-primary', e.target.value);
                c3iState.settings.shiftColors.primary = e.target.value;
                saveUserSettings();
            });
            secondaryColorInput.addEventListener('input', (e) => {
                document.body.style.setProperty('--color-shift-secondary', e.target.value);
                c3iState.settings.shiftColors.secondary = e.target.value;
                saveUserSettings();
            });
            tertiaryColorInput.addEventListener('input', (e) => {
                document.body.style.setProperty('--color-shift-tertiary', e.target.value);
                c3iState.settings.shiftColors.tertiary = e.target.value;
                saveUserSettings();
            });
            
            updateActiveThemeButton();
            updateColorPickersFromCSS();
            
            const container = document.getElementById('audit-log-container');
            function renderLog() {
                 if (!container) return;
                let logHtml = `<table class="data-table text-xs"><thead><tr class="border-b border-primary/20"><th class="p-2">Timestamp</th><th class="p-2">Operator</th><th class="p-2">Action</th><th class="p-2">Details</th></tr></thead><tbody>`;
                c3iState.auditLog.slice().reverse().forEach(log => {
                    logHtml += `<tr class="border-b border-gray-800"><td class="p-2">${log.timestamp.toLocaleString()}</td><td class="p-2 text-primary">${log.operator}</td><td class="p-2">${log.action}</td><td class="p-2">${log.details}</td></tr>`;
                });
                logHtml += `</tbody></table>`;
                container.innerHTML = logHtml;
            }

            window.addEventListener('logUpdated', renderLog);
            renderLog();
        }

        // --- MAIN (main.js) ---
        document.addEventListener('DOMContentLoaded', () => {
            bootState.stages = document.querySelectorAll('.boot-stage');
            bootState.cursor = document.getElementById('custom-cursor');
            bootState.loginForm = document.getElementById('login-form');
            bootState.loginError = document.getElementById('login-error');

            window.addEventListener('mousemove', e => {
                bootState.mousePos = { x: e.clientX, y: e.clientY };
                if (bootState.cursor) {
                    bootState.cursor.style.left = e.clientX + 'px';
                    bootState.cursor.style.top = e.clientY + 'px';
                }
            });

            async function startHandler() {
                window.removeEventListener('keydown', startHandler);
                window.removeEventListener('click', startHandler);
                
                // Initialize Firebase and load data before starting boot sequence
                const firebaseReady = await initFirebase();
                if (!firebaseReady) {
                    console.error("Halting boot due to Firebase initialization failure.");
                    return;
                }
                
                // Initialize sound AFTER settings have been loaded from Firebase
                initSound();

                runBootSequence();
            }

            window.addEventListener('keydown', startHandler);
            window.addEventListener('click', startHandler);

            window.addEventListener('resize', () => {
                for (const instance of bootState.threeInstances) {
                    const { renderer, camera, container, composer } = instance;
                    if (container && document.body.contains(container)) {
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        if (width > 0 && height > 0) {
                            camera.aspect = width / height;
                            camera.updateProjectionMatrix();
                            renderer.setSize(width, height);
                            if (composer) composer.setSize(width, height);
                        }
                    }
                }
            });

            bootState.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const codename = e.target.username.value.toLowerCase();
                const password = e.target.password.value;
                const user = c3iState.intel.users[codename];

                if (codename === 'rocketman') {
                    logAction('INTRUSION ATTEMPT', 'User: rocketman');
                    if(bootState.soundInitialized) {
                        const alarmSynth = new Tone.Synth({ oscillator: { type: 'sawtooth' } }).toDestination();
                        const alarmLoop = new Tone.Loop(time => {
                            alarmSynth.triggerAttackRelease("A5", "16n", time);
                        }, "8n").start(0);
                        Tone.Transport.start();
                    }
                    switchStage(5); // Lockdown stage
                    return;
                }

                if (user && user.password === password) {
                    c3iState.currentUser = { codename: codename, ...user };
                    logAction('User Login');
                    showDesktop();
                } else {
                    if(bootState.soundInitialized) bootState.failSynth.triggerAttackRelease("G2", "1n");
                    bootState.loginError.style.display = 'block';
                    setTimeout(() => { bootState.loginError.style.display = 'none'; }, 1500);
                }
            });

            function showDesktop() {
                if(bootState.soundInitialized) bootState.successSynth.triggerAttackRelease("C4", "2n");
                document.getElementById('boot-container').style.display = 'none';
                document.getElementById('desktop').style.display = 'block';
                initializeC3IApp();
            }
            
            initOfflineVisuals();
        });
    </script>
</body>
</html>
